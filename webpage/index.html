<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanity overview</title>
    <link rel="icon" type="image/x-icon" href="/favico.ico">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Chart.js for points trend graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- NProgress for Loading Bar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #122a3d; /* custom-blue-900 */
            color: #e2e8f0; /* Light text for dark background */
        }
        /* Custom scrollbar for table */
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #1a364d; /* custom-blue-800 */
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #224b6d; /* custom-blue-700 */
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #2a608d; /* custom-blue-600 */
        }
        /* Style for sortable headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th.sortable svg {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        th.sortable.asc svg.asc-icon {
            opacity: 1;
            color: #33b8e6; /* custom-blue-400 */
        }
        th.sortable.desc svg.desc-icon {
            opacity: 1;
            color: #33b8e6; /* custom-blue-400 */
        }
        /* Style for pagination buttons */
        .pagination-button {
            @apply px-3 py-1 rounded-md text-sm font-medium;
            @apply bg-custom-blue-700 text-white hover:bg-custom-blue-600 transition-colors duration-150;
        }
        .pagination-button.active {
            @apply bg-custom-blue-500;
        }
        .pagination-button:disabled {
            @apply bg-gray-600 text-gray-400 cursor-not-allowed;
        }
        /* Style for wrapping long text in table cells */
        .wrap-text {
            white-space: normal;
            word-break: break-word;
        }

        /* NProgress Customization */
        #nprogress .bar {
          background: #00a3d1 !important; /* custom-blue-500 */
          height: 3px !important;
        }
        #nprogress .peg {
          box-shadow: 0 0 10px #00a3d1, 0 0 5px #00a3d1 !important;
        }
        #nprogress .spinner-icon {
          border-top-color: #00a3d1 !important;
          border-left-color: #00a3d1 !important;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': {
                            100: '#e0f3f8',
                            200: '#b3e1f0',
                            300: '#66c9ef',
                            400: '#33b8e6',
                            500: '#00a3d1',
                            600: '#2a608d',
                            700: '#224b6d',
                            800: '#1a364d',
                            900: '#122a3d',
                        },
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-custom-blue-800 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-center items-center">
            <div class="text-2xl font-bold mb-4 md:mb-0 md:mr-8"><a href="#home" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('home')">Sanity</a></div>
            <ul class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-8 text-lg font-medium items-center">
                <li><a href="#diary" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('diary')">Diary Times</a></li>
                <li><a href="#users" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('users')">Users</a></li>
                <li><a href="#personalbests" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('personalbests')">Posted Pbs</a></li>
                <li><a href="#drops" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('drops')">Posted Drops</a></li>
                <li><a href="#points" class="hover:text-custom-blue-300 transition-colors duration-200" onclick="showPage('points')">Points</a></li>
                <li class="relative group flex items-center">
                    <span>Other</span>
                    <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <ul class="absolute invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity duration-300 bg-custom-blue-700 text-white py-2 rounded-md shadow-lg w-48 min-w-max top-full left-0 z-10">
                        <li><a href="#approved-stats" class="block px-4 py-2 hover:bg-custom-blue-600 transition-colors duration-200" onclick="showPage('approved-stats')">Approved Stats</a></li>
                        <li><a href="#userprofile" class="block px-4 py-2 hover:bg-custom-blue-600 transition-colors duration-200" onclick="showPage('userprofile')">User Profile</a></li>
                        <li><a href="#halloffame" class="block px-4 py-2 hover:bg-custom-blue-600 transition-colors duration-200" onclick="showPage('halloffame')">Hall of Fame</a></li>
                        <li><a href="#pbhiscores" class="block px-4 py-2 hover:bg-custom-blue-600 transition-colors duration-200" onclick="showPage('pbhiscores')">PB Hiscores</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Home Page Content -->
        <section id="home-page" class="page-content bg-custom-blue-900">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/yrepXwU.png" alt="Sanity Clan Banner" class="mx-auto rounded-lg shadow-lg">
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Ranks Table -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Ranks</h2>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-gray-900 text-gray-200">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rank</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Points Required</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Additional Requirements</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Maintenance points*</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <tr><td class="px-6 py-4">Master</td><td class="px-6 py-4">20.000</td><td class="px-6 py-4">100 Diary Points OR 5 Master Diaries</td><td class="px-6 py-4">150</td></tr>
                                <tr><td class="px-6 py-4">Champion</td><td class="px-6 py-4">15.000</td><td class="px-6 py-4">80 Diary Points OR 4 Master Diaries</td><td class="px-6 py-4">150</td></tr>
                                <tr><td class="px-6 py-4">Legend</td><td class="px-6 py-4">11.000</td><td class="px-6 py-4">60 Diary Points OR 3 Master Diaries</td><td class="px-6 py-4">150</td></tr>
                                <tr><td class="px-6 py-4">Veteran</td><td class="px-6 py-4">11.000</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td></tr>
                                <tr><td class="px-6 py-4">Hero</td><td class="px-6 py-4">8.000</td><td class="px-6 py-4">40 Diary Points OR 2 Master Diaries</td><td class="px-6 py-4">150</td></tr>
                                <tr><td class="px-6 py-4">Prestiged</td><td class="px-6 py-4">5.000</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td></tr>
                                <tr><td class="px-6 py-4">Elite</td><td class="px-6 py-4">2.500</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td></tr>
                                <tr><td class="px-6 py-4">Advanced</td><td class="px-6 py-4">1.000</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td></tr>
                                <tr><td class="px-6 py-4">Member</td><td class="px-6 py-4">150</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- How to rank up -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">How to Rank Up</h2>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-gray-900 text-gray-200">
                             <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Activity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Points</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <tr><td class="px-6 py-4">PvMing</td><td class="px-6 py-4">1M = 1 Point</td></tr>
                                <tr><td class="px-6 py-4">Pvming with Multiple Trials</td><td class="px-6 py-4">2x Points for ALL</td></tr>
                                <tr><td class="px-6 py-4">PvMing with Trial Members</td><td class="px-6 py-4">2x Points for Full Members+</td></tr>
                                <tr><td class="px-6 py-4">Pets</td><td class="px-6 py-4">Drop Rate/100 (see Point Values tab)</td></tr>
                                <tr><td class="px-6 py-4">Events</td><td class="px-6 py-4">Up to 100 (depending on the event)</td></tr>
                                <tr><td class="px-6 py-4">Discord Nitro</td><td class="px-6 py-4">50 per month (on 1st)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
             <!-- Criteria for ranking up -->
             <div class="bg-gray-800 p-6 rounded-lg shadow-md mt-8">
                <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Criteria for Ranking Up</h2>
                <ul class="list-disc list-inside space-y-2 text-gray-300">
                    <li>PvM drops must be worth over 2m and clue uniques must have a stand alone value over 4m. This implies e.g. an Abyssal whip worth 1.6m WILL be rejected - Please ask Pondez for further info</li>
                    <li>Uniques ONLY</li>
                    <li>Solo drops count for full points (trials do not apply)</li>
                    <li>Solo iron drops can only be submitted by hero+ for points</li>
                    <li>Team drops must be with at least one other Sanity member, and received by a Sanity member.</li>
                    <li>Drops in Sanity masses can be submitted as solo drops</li>
                    <li>Screenshots must show the chat box with the clan broadcast, KC, and who else is in the raid.</li>
                    <li>*Nitro counts towards maintenance points but not activity points</li>
                </ul>
            </div>
        </section>

        <!-- Diary Times Page Content -->
        <section id="diary-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-4 text-center">Welcome to Sanity's Achievement Diary!</h1>
                <p class="text-gray-300 mb-4">This diary provides you the opportunity to track your personal best times for raids and selected bosses.</p>
                <p class="text-gray-300 mb-6">Type <code class="bg-gray-900 text-custom-blue-400 px-2 py-1 rounded">/pbsubmission</code> in <code class="bg-gray-900 text-custom-blue-400 px-2 py-1 rounded">#pb-submission</code> to submit times towards your diary.</p>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Rules</h2>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li>You must have a screenshot of your PB to count. Previous PBs will NOT count (Solo PBs excluded).</li>
                            <li>Just typing <code class="bg-gray-900 text-custom-blue-400 px-1 py-0.5 rounded">!pb</code> in game will not count.</li>
                            <li>All team submissions must consist of Sanity members only.</li>
                            <li>Submissions must show boss KC and each member involved in the PB to count.</li>
                            <li>If a Sanity member in your previous PB leaves the clan, you will still keep the PB for the diary.</li>
                            <li>Trial members cannot claim clan points from the diary until after they reach member status.</li>
                        </ul>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Rewards</h2>
                        <div class="overflow-x-auto table-container">
                            <table class="min-w-full bg-gray-900 text-gray-200">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Task Completion</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Points</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tier Reward</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Clan Points</th>
                                    </tr>
                                </thead>
                                <tbody id="diaryRewardsTableBody" class="divide-y divide-gray-700">
                                    <!-- Dynamic content based on API -->
                                    <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading rewards...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-custom-blue-400 mt-8 mb-4">Achievement Diary Times</h2>
                <div class="overflow-x-auto table-container">
                    <table class="min-w-full bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Boss Name (Scale)</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Easy Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Medium Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Hard Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Elite Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Master Time</th>
                            </tr>
                        </thead>
                        <tbody id="diaryTimesTableBody" class="divide-y divide-gray-700">
                            <!-- Dynamic content based on API -->
                            <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading diary times...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Users Page Content -->
        <section id="users-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">Users Overview</h1>

                <div class="mb-6">
                    <input type="text" id="searchInput" placeholder="Search table..."
                           class="w-full p-3 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-500 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                </div>

                <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                    <table id="usersTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg sortable" data-column="displayName" data-type="string">Display Name
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="points" data-type="number">Points
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="rank_name" data-type="string">Rank
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="mainRSN" data-type="string">Main RSN
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="altRSN" data-type="string">Alt RSN
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="joinDate" data-type="date">Join Date
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="diaryPoints" data-type="number">Diary Points
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="masterDiaryPoints" data-type="number">Master Diaries
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg sortable" data-column="flavourText" data-type="string">Diary Tier Claimed
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="points_past_3_months" data-type="number">Points (3m)
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <tr><td colspan="11" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                 <div id="usersPagination" class="flex justify-center mt-4 space-x-2"></div>
            </div>
        </section>

        <!-- Personal Bests Page Content -->
        <section id="personalbests-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">Personal Bests Overview</h1>

                <div class="mb-6">
                    <input type="text" id="personalBestsSearchInput" placeholder="Search table..."
                           class="w-full p-3 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-500 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                </div>

                <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                    <table id="personalBestsTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg sortable" data-column="submissionId" data-type="number">Submission ID
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="member_names" data-type="string">Members
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="boss_name" data-type="string">Boss Name
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="scale" data-type="number">Scale
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="time" data-type="number">Time
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="imageUrl" data-type="string">Image
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg sortable" data-column="submittedDate" data-type="date">Submitted Date
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <tr><td colspan="7" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="personalBestsPagination" class="flex justify-center mt-4 space-x-2"></div>
            </div>
        </section>

        <!-- Drops Page Content -->
        <section id="drops-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">Drops Overview</h1>

                <div class="mb-6">
                    <input type="text" id="dropsSearchInput" placeholder="Search table..."
                           class="w-full p-3 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-500 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                </div>

                <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                    <table id="dropsTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg sortable" data-column="Id" data-type="number">ID
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="submitter" data-type="string">Submitter
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="member_names" data-type="string">Participants
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="notes" data-type="string">Notes
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="value" data-type="number">Value (GP)
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="status_name" data-type="string">Status
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="imageUrl" data-type="string">Image
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0  011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="reviewedDate" data-type="date">Review Date
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg sortable" data-column="reviewer" data-type="string">Reviewer
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <!-- Table rows will be inserted here by JavaScript -->
                            <tr><td colspan="9" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Drops Pagination Controls -->
                <div id="dropsPagination" class="flex justify-center mt-4 space-x-2"></div>
            </div>
        </section>

        <!-- Points Page Content -->
        <section id="points-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">Points Overview</h1>

                <div class="mb-6">
                    <input type="text" id="pointsSearchInput" placeholder="Search table..."
                           class="w-full p-3 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-500 transition-all duration-200 bg-gray-700 text-white placeholder-gray-400">
                </div>

                <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                    <table id="pointsTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg sortable" data-column="Id" data-type="number">ID
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="displayName" data-type="string">Display Name
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="points" data-type="number">Points
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="notes" data-type="string">Notes
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sortable" data-column="messageUrl" data-type="string">Message Link
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg sortable" data-column="date" data-type="date">Date
                                    <svg class="asc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <svg class="desc-icon h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <!-- Table rows will be inserted here by JavaScript -->
                            <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Points Pagination Controls -->
                <div id="pointsPagination" class="flex justify-center mt-4 space-x-2"></div>
            </div>
        </section>

        <!-- Hall of Fame Page Content -->
        <section id="halloffame-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6 text-center">Hall of Fame - Bingo Winners</h1>
                <div id="bingoWinnersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     <p class="text-center text-gray-400 col-span-full">Loading winners...</p>
                </div>
            </div>
        </section>


        <!-- Placeholder for Points Sub-item -->
        <section id="points_subitem-page" class="page-content bg-gray-800 p-8 rounded-lg shadow-md mb-8 hidden text-gray-200">
            <h1 class="text-3xl font-bold text-custom-blue-400 mb-4">Points Sub-item Page (Directly Accessible)</h1>
            <p class="text-gray-300">This page was previously linked from the Points dropdown. It can still be accessed directly via URL hash or programmatic calls.</p>
        </section>
        <!-- New "Other" page for its main link -->
        <section id="other-page" class="page-content bg-gray-800 p-8 rounded-lg shadow-md mb-8 hidden text-gray-200">
            <h1 class="text-3xl font-bold text-custom-blue-400 mb-4">Other Main Page</h1>
            <p class="text-gray-300">Content for the main Other page will go here.</p>
        </section>
        <!-- Approved Stats Page -->
        <section id="approved-stats-page" class="page-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Approved Drops Table -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Approved Drops (Last 12 Months)</h2>
                    <div class="overflow-x-auto table-container">
                        <table id="approvedDropsTable" class="min-w-full bg-gray-900 text-gray-200">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reviewer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <tr><td colspan="3" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Approved PBs Table -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Approved PBs (Last 12 Months)</h2>
                    <div class="overflow-x-auto table-container">
                        <table id="approvedPbsTable" class="min-w-full bg-gray-900 text-gray-200">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reviewer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                 <tr><td colspan="3" class="text-center py-4 text-gray-400">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- User Profile Page Content -->
        <section id="userprofile-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">User Profile</h1>

                <!-- User Selection Dropdown -->
                <div class="mb-6">
                    <label for="userSelect" class="block text-gray-300 text-lg font-medium mb-2">Select User:</label>
                    <select id="userSelect" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-custom-blue-500">
                        <option value="">-- Select a User --</option>
                    </select>
                </div>

                <!-- User Details Summary -->
                <div id="userDetailsSummary" class="bg-gray-700 p-6 rounded-lg shadow-md mb-8 hidden">
                    <div class="flex items-center mb-4">
                        <img id="userAvatar" src="https://placehold.co/80x80/2a608d/ffffff?text=User" alt="User Avatar" class="w-20 h-20 rounded-full mr-4 border-2 border-custom-blue-400">
                        <div>
                            <h2 id="userNameDisplay" class="text-3xl font-bold text-custom-blue-400"></h2>
                            <p class="text-lg text-gray-300 flex items-center">
                                <span class="mr-2">Rank:</span>
                                <img id="userRankIcon" src="" alt="Rank Icon" class="w-[13px] h-[13px] inline-block mr-1" onerror="this.onerror=null;this.src='https://placehold.co/13x13/2a608d/ffffff?text=?'">
                                <span id="userRankName"></span>
                            </p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-gray-200">
                        <p><strong>Overall Points:</strong> <span id="userOverallPoints"></span></p>
                        <p><strong>Main RSN:</strong> <span id="userMainRsn"></span></p>
                        <p><strong>Alt RSN:</strong> <span id="userAltRsn"></span></p>
                        <p><strong>Join Date:</strong> <span id="userJoinDate"></span></p>
                        <p><strong>Diary Points:</strong> <span id="userDiaryPoints"></span></p>
                        <p><strong>Master Diaries:</strong> <span id="userMasterDiaryPoints"></span></p>
                        <p><strong>Points (Past 3 Months):</strong> <span id="userPoints3Months"></span></p>
                        <p><strong>Diary Tier Claimed:</strong> <span id="userFlavourText"></span></p>
                    </div>
                     <button id="shareProfileButton" class="mt-6 px-6 py-3 bg-custom-blue-500 text-white font-bold rounded-md hover:bg-custom-blue-600 transition-colors duration-200 shadow-lg">
                        Copy Profile Link
                    </button>
                    <div id="copyFeedback" class="mt-2 text-sm text-green-400 hidden"></div>
                </div>

                <!-- Overall Progress/Statistics -->
                <div id="overallStatsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8 hidden">
                    <div class="bg-gray-700 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Points Trend</h2>
                        <div class="relative h-64">
                            <canvas id="pointsTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Submission Statistics</h2>
                        <div class="text-gray-200 text-lg space-y-2">
                            <p><strong>Total Drops Submitted:</strong> <span id="totalDropsSubmitted">0</span></p>
                            <p><strong>Total Personal Bests Submitted:</strong> <span id="totalPbsSubmitted">0</span></p>
                        </div>
                    </div>
                </div>

            <!-- Container for side-by-side tables -->
            <div class="flex flex-wrap lg:flex-nowrap gap-8 mt-8">
                <div id="recentDropsSection" class="w-full lg:w-1/2 hidden">
                    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">5 Most Recent Drops</h2>
                    <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Participants</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Note</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentDropsTableBody">
                                <tr><td colspan="5" class="text-center py-4 text-gray-400">No recent drops found.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Selected User's Personal Bests -->
                <div id="personalBestsProfileSection" class="w-full lg:w-1/2 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="personalBestsTitle" class="text-2xl font-bold text-custom-blue-400">5 Most Recent Personal Bests</h2>
                        <button id="togglePbViewBtn" class="px-4 py-2 bg-custom-blue-600 text-white text-sm font-medium rounded-md hover:bg-custom-blue-500 transition-colors duration-200">
                            Show Unique Bests
                        </button>
                    </div>
                    <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Boss Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Scale</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Best Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                                </tr>
                            </thead>
                            <tbody id="personalBestsProfileTableBody">
                                <tr><td colspan="4" class="text-center py-4 text-gray-400">No personal bests found.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            </div>
        </section>

        <!-- PB Hiscores Page Content -->
        <section id="pbhiscores-page" class="page-content hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">Personal Best Hiscores</h1>
                <div id="pbHiscoresContainer">
                    <p class="text-center py-4 text-gray-400">Loading PB hiscores...</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-custom-blue-800 text-white text-center p-4 shadow-inner mt-8">
        <p>&copy; 2025 Sanity OSRS clan</p>
    </footer>

    <script>
        console.log('Script started parsing.');

        // --- NProgress Configuration ---
        NProgress.configure({ showSpinner: false });

        // --- Wrapper for fetch to show loading bar ---
        async function fetchWithLoader(url, options) {
            NProgress.start();
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                // Optionally show an error message to the user
                throw error; // Re-throw to be handled by the caller
            } finally {
                NProgress.done();
            }
        }

        // --- Global Data and API URLs ---
        let allUsersData = [];
        let allPersonalBestsData = [];
        let filteredAndSortedPersonalBests = [];
        let allDropsData = [];
        let filteredAndSortedDrops = [];
        let allPointsData = [];
        let filteredAndSortedPoints = [];
        let allPointsDataForGraph = [];
        let allDiaryTimesData = [];

        let pointsTrendChartInstance = null;
        let currentPbView = 'recent';


        const API_BASE = 'https://sanityosrs.com/api';
        const USERS_API_URL = `${API_BASE}/users`;
        const PERSONALBESTS_API_URL = `${API_BASE}/personalbests`;
        const DROPS_API_URL = `${API_BASE}/drops`;
        const POINTS_API_URL = `${API_BASE}/points`;
        const APPROVEDDROPS_API_URL = `${API_BASE}/approveddrops`;
        const APPROVEDPBS_API_URL = `${API_BASE}/approvedpbs`;
        const BINGOWINNERS_API_URL = `${API_BASE}/bingowinners`;
        const DIARYTIMES_API_URL = `${API_BASE}/diarytimes`;


        // --- Sorting State for Users Table ---
        let usersCurrentSortColumn = null;
        let usersCurrentSortDirection = 'asc';
        let usersCurrentPage = 1;
        const usersItemsPerPage = 200;


        // --- Sorting State for Personal Bests Table ---
        let pbsCurrentSortColumn = 'submissionId';
        let pbsCurrentSortDirection = 'desc';
        let pbsCurrentPage = 1;
        const pbsItemsPerPage = 200;

        // --- Sorting State for Drops Table ---
        let dropsCurrentSortColumn = 'Id';
        let dropsCurrentSortDirection = 'desc';
        let dropsCurrentPage = 1;
        const dropsItemsPerPage = 200;

        // --- Sorting State for Points Table ---
        let pointsCurrentSortColumn = 'Id';
        let pointsCurrentSortDirection = 'desc';
        let pointsCurrentPage = 1;
        const pointsItemsPerPage = 200;


        // --- Utility Function for Date Formatting ---
        function formatToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            const dateObj = new Date(dateString);
            if (isNaN(dateObj.getTime())) return 'N/A';
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // --- Utility Functions for Time Formatting and Parsing ---
        function parseTimeMs(timeString) {
            if (!timeString || typeof timeString !== 'string') return NaN;
            const parts = timeString.split(/[:,\.]/);

            if (parts.length !== 3) {
                console.warn(`Invalid time format: ${timeString}. Expected MMM:SS,MS or MMM:SS.MS.`);
                return NaN;
            }

            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            const hundredths = parseInt(parts[2], 10);

            if (isNaN(minutes) || isNaN(seconds) || isNaN(hundredths)) {
                return NaN;
            }
            return (minutes * 60 * 1000) + (seconds * 1000) + (hundredths * 10);
        }

        function formatTimeFromMs(totalMs) {
            if (typeof totalMs !== 'number' || isNaN(totalMs) || totalMs < 0) {
                return 'N/A';
            }

            const minutes = Math.floor(totalMs / (60 * 1000));
            const remainingMsAfterMinutes = totalMs % (60 * 1000);
            const seconds = Math.floor(remainingMsAfterMinutes / 1000);
            const milliseconds = Math.round(remainingMsAfterMinutes % 1000);

            const hundredths = Math.floor(milliseconds / 10);

            const formattedMs = String(hundredths).padStart(2, '0');
            const formattedSeconds = String(seconds).padStart(2, '0');
            const formattedMinutes = String(minutes);

            return `${formattedMinutes}:${formattedSeconds},${formattedMs}`;
        }

        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) {
                return 'N/A';
            }
            return value.toLocaleString('en-US');
        }

        // --- Utility Function for generating visible page numbers ---
        function generatePageNumbers(currentPage, totalPages, maxVisiblePages) {
            const pages = new Set();
            pages.add(1);
            if (totalPages > 1) {
                pages.add(totalPages);
            }

            const middlePagesToShow = maxVisiblePages - 2;

            let startWindow = Math.max(2, currentPage - Math.floor(middlePagesToShow / 2));
            let endWindow = Math.min(totalPages - 1, currentPage + Math.ceil(middlePagesToShow / 2) -1);

            if (endWindow - startWindow + 1 < middlePagesToShow) {
                if (startWindow === 2) {
                    endWindow = Math.min(totalPages - 1, startWindow + middlePagesToShow - 1);
                } else if (endWindow === totalPages - 1) {
                    startWindow = Math.max(2, endWindow - middlePagesToShow + 1);
                }
            }


            for (let i = startWindow; i <= endWindow; i++) {
                pages.add(i);
            }

            const sortedPages = Array.from(pages).sort((a, b) => a - b);
            const finalPages = [];
            let lastAddedPage = 0;

            for (const pageNum of sortedPages) {
                if (lastAddedPage !== 0 && pageNum > lastAddedPage + 1) {
                    finalPages.push('...');
                }
                finalPages.push(pageNum);
                lastAddedPage = pageNum;
            }
            return finalPages;
        }

        // --- Data Preloading Function ---
        async function preloadAllData() {
            console.log("Preloading all data...");
            NProgress.start(); // Start loading bar for the whole preload process
            try {
                const [usersRes, dropsRes, pbsRes, pointsRes, diaryTimesRes] = await Promise.all([
                    fetch(USERS_API_URL),
                    fetch(DROPS_API_URL),
                    fetch(PERSONALBESTS_API_URL),
                    fetch(POINTS_API_URL),
                    fetch(DIARYTIMES_API_URL)
                ]);

                allUsersData = await usersRes.json();
                allDropsData = await dropsRes.json();
                allPersonalBestsData = await pbsRes.json();
                allPointsData = await pointsRes.json();
                allDiaryTimesData = await diaryTimesRes.json();

                allPointsDataForGraph = allPointsData;

                console.log("All data preloaded successfully.");
            } catch (error) {
                console.error("Failed to preload data:", error);
            } finally {
                NProgress.done(); // Finish loading bar
            }
        }


        // --- User Table Functions ---
        function fetchUsersData() {
            applyUsersFiltersAndSort();
        }

        function applyUsersFiltersAndSort() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredData = allUsersData.filter(user => {
                return Object.values(user).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
            });
            if (usersCurrentSortColumn) {
                sortData(filteredData, usersCurrentSortColumn, usersCurrentSortDirection, '#usersTable');
            }
            renderUsersTable(filteredData);
        }

        function renderUsersTable(usersToDisplay) {
            const tableBody = document.querySelector('#usersTable tbody');
            tableBody.innerHTML = '';

            if (usersToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-400">No matching users found.</td></tr>`;
                return;
            }

            const startIndex = (usersCurrentPage - 1) * usersItemsPerPage;
            const endIndex = startIndex + usersItemsPerPage;
            const usersToDisplayOnPage = usersToDisplay.slice(startIndex, endIndex);

            usersToDisplayOnPage.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                const formattedPoints = user.points ? parseInt(user.points).toLocaleString('de-DE') : '0';
                const formattedPoints3Months = user.points_past_3_months ? parseInt(user.points_past_3_months).toLocaleString('de-DE') : '0';
                const formattedJoinDate = formatToDDMMYYYY(user.joinDate);
                const displayNameContent = `<a href="#userprofile?user=${encodeURIComponent(user.displayName)}" class="text-custom-blue-400 hover:underline">${user.displayName || 'N/A'}</a>`;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${displayNameContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedPoints}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.rank_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.mainRSN || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.altRSN || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedJoinDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.diaryPoints || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.masterDiaryPoints || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${user.flavourText || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedPoints3Months}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('#usersTable thead th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.dataset.column === usersCurrentSortColumn) {
                    header.classList.add(usersCurrentSortDirection);
                }
            });
            renderUsersPagination(usersToDisplay.length);
        }

        function renderUsersPagination(totalItems) {
            const paginationContainer = document.getElementById('usersPagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalItems / usersItemsPerPage);
            if (totalPages <= 1) return;
        }

        function handleUsersSearch() {
            usersCurrentPage = 1;
            applyUsersFiltersAndSort();
        }

        function sortUsersTable(column) {
            usersCurrentPage = 1;
            if (usersCurrentSortColumn === column) {
                usersCurrentSortDirection = (usersCurrentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                usersCurrentSortColumn = column;
                usersCurrentSortDirection = 'asc';
            }
            applyUsersFiltersAndSort();
        }

        function sortData(data, column, direction, tableSelector) {
            if (!column) return;
            let sortKey = column;
            const header = document.querySelector(`${tableSelector} th[data-column="${column}"]`);
            if (!header) return;
            let type = header.dataset.type;

            if (column === 'rank_name') {
                 sortKey = 'rankId';
                 type = 'number';
            }
            if (column === 'flavourText') {
                 sortKey = 'diaryTierClaimed';
                 type = 'number';
            }

            data.sort((a,b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (type === 'number') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (type === 'date') {
                    valA = new Date(valA).getTime() || 0;
                    valB = new Date(valB).getTime() || 0;
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }


        // --- Personal Bests Table Functions ---
        function fetchPersonalBestsData() {
            applyPersonalBestsFiltersAndSort();
        }

        function applyPersonalBestsFiltersAndSort() {
            console.log('Applying Personal Bests filters and sort...');
            const searchTerm = document.getElementById('personalBestsSearchInput').value.toLowerCase();
            filteredAndSortedPersonalBests = allPersonalBestsData.filter(pb => {
                const timeForSearch = pb.time ? formatTimeFromMs(parseTimeMs(pb.time)) : '';
                const dateForSearch = pb.submittedDate ? formatToDDMMYYYY(pb.submittedDate) : '';

                return (pb.submissionId ? String(pb.submissionId).toLowerCase().includes(searchTerm) : false) ||
                       (pb.member_names ? String(pb.member_names).toLowerCase().includes(searchTerm) : false) ||
                       (pb.boss_name ? String(pb.boss_name).toLowerCase().includes(searchTerm) : false) ||
                       (pb.scale ? String(pb.scale).toLowerCase().includes(searchTerm) : false) ||
                       timeForSearch.includes(searchTerm) ||
                       (pb.imageUrl ? String(pb.imageUrl).toLowerCase().includes(searchTerm) : false) ||
                       dateForSearch.includes(searchTerm);
            });

            filteredAndSortedPersonalBests.sort((a, b) => {
                let valA = a[pbsCurrentSortColumn];
                let valB = b[pbsCurrentSortColumn];

                if (pbsCurrentSortColumn === 'time') {
                    valA = parseTimeMs(valA);
                    valB = parseTimeMs(valB);
                    if (isNaN(valA)) valA = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    if (isNaN(valB)) valB = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    return (valA - valB) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                }

                const type = document.querySelector(`#personalBestsTable th[data-column="${pbsCurrentSortColumn}"]`).dataset.type;

                if (valA === null || valA === undefined) valA = (type === 'number' || type === 'date') ? (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';
                if (valB === null || valB === undefined) valB = (type === 'number' || type === 'date') ? (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';

                if (type === 'number') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                    if (isNaN(valA)) valA = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    if (isNaN(valB)) valB = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    return (valA - valB) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                } else if (type === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                    if (isNaN(valA.getTime())) valA = new Date(0);
                    if (isNaN(valB.getTime())) valB = new Date(0);
                    return (valA.getTime() - valB.getTime()) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                } else { // string
                    return valA.toString().localeCompare(valB.toString()) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                }
            });
            renderPersonalBestsTable(filteredAndSortedPersonalBests);
        }

        function renderPersonalBestsTable(pbsToDisplay) {
            const tableBody = document.querySelector('#personalBestsTable tbody');
            tableBody.innerHTML = '';

            if (pbsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-400">No matching personal bests found.</td></tr>`;
                return;
            }

            const startIndex = (pbsCurrentPage - 1) * pbsItemsPerPage;
            const endIndex = startIndex + pbsItemsPerPage;
            const pbsToDisplayOnPage = pbsToDisplay.slice(startIndex, endIndex);

            pbsToDisplayOnPage.forEach(pb => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                const formattedTime = pb.time ? formatTimeFromMs(parseTimeMs(pb.time)) : 'N/A';
                const formattedSubmittedDate = formatToDDMMYYYY(pb.submittedDate);

                const imageUrlContent = generateImageUrlContent(pb.imageUrl);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${pb.submissionId || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${pb.member_names || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${pb.boss_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${pb.scale || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${imageUrlContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedSubmittedDate}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('#personalBestsTable thead th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.dataset.column === pbsCurrentSortColumn) {
                    header.classList.add(pbsCurrentSortDirection);
                }
            });

            renderPersonalBestsPagination(pbsToDisplay.length);
        }


        function renderPersonalBestsPagination(totalItems) {
            const paginationContainer = document.getElementById('personalBestsPagination');
            paginationContainer.innerHTML = '';

            const totalPages = Math.ceil(totalItems / pbsItemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            const visiblePageNumbers = generatePageNumbers(pbsCurrentPage, totalPages, 6);

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.classList.add('pagination-button');
            prevButton.disabled = pbsCurrentPage === 1;
            prevButton.onclick = () => {
                if (pbsCurrentPage > 1) {
                    pbsCurrentPage--;
                    renderPersonalBestsTable(filteredAndSortedPersonalBests);
                }
            };
            paginationContainer.appendChild(prevButton);

            visiblePageNumbers.forEach(pageNum => {
                if (pageNum === '...') {
                    const ellipsisSpan = document.createElement('span');
                    ellipsisSpan.textContent = '...';
                    ellipsisSpan.classList.add('px-3', 'py-1', 'text-gray-400');
                    paginationContainer.appendChild(ellipsisSpan);
                } else {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = pageNum;
                    pageButton.classList.add('pagination-button');
                    if (pageNum === pbsCurrentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.onclick = () => {
                        pbsCurrentPage = pageNum;
                        renderPersonalBestsTable(filteredAndSortedPersonalBests);
                    };
                    paginationContainer.appendChild(pageButton);
                }
            });

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.classList.add('pagination-button');
            nextButton.disabled = pbsCurrentPage === totalPages;
            nextButton.onclick = () => {
                if (pbsCurrentPage < totalPages) {
                    pbsCurrentPage++;
                    renderPersonalBestsTable(filteredAndSortedPersonalBests);
                }
            };
            paginationContainer.appendChild(nextButton);
        }

        function sortPersonalBestsTable(column, type) {
            pbsCurrentPage = 1;
            if (pbsCurrentSortColumn === column) {
                pbsCurrentSortDirection = (pbsCurrentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                pbsCurrentSortColumn = column;
                pbsCurrentSortDirection = 'asc';
            }
            applyPersonalBestsFiltersAndSort();
        }

        // --- Drops Table Functions ---
        function fetchDropsData() {
            applyDropsFiltersAndSort();
        }

        function applyDropsFiltersAndSort() {
            console.log('Applying Drops filters and sort...');
            const searchTerm = document.getElementById('dropsSearchInput').value.toLowerCase();
            filteredAndSortedDrops = allDropsData.filter(drop => {
                const valueForSearch = drop.value ? String(drop.value).toLowerCase() : '';
                const reviewedDateForSearch = drop.reviewedDate ? formatToDDMMYYYY(drop.reviewedDate).toLowerCase() : '';

                return (drop.Id ? String(drop.Id).toLowerCase().includes(searchTerm) : false) ||
                       (drop.submitter ? String(drop.submitter).toLowerCase().includes(searchTerm) : false) ||
                       (drop.member_names ? String(drop.member_names).toLowerCase().includes(searchTerm) : false) ||
                       (drop.notes ? String(drop.notes).toLowerCase().includes(searchTerm) : false) ||
                       valueForSearch.includes(searchTerm) ||
                       (drop.status_name ? String(drop.status_name).toLowerCase().includes(searchTerm) : false) ||
                       (drop.imageUrl ? String(drop.imageUrl).toLowerCase().includes(searchTerm) : false) ||
                       reviewedDateForSearch.includes(searchTerm) ||
                       (drop.reviewer ? String(drop.reviewer).toLowerCase().includes(searchTerm) : false);
            });

            filteredAndSortedDrops.sort((a, b) => {
                let valA = a[dropsCurrentSortColumn];
                let valB = b[dropsCurrentSortColumn];

                const type = document.querySelector(`#dropsTable th[data-column="${dropsCurrentSortColumn}"]`).dataset.type;

                if (valA === null || valA === undefined) valA = (type === 'number' || type === 'date') ? (dropsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';
                if (valB === null || valB === undefined) valB = (type === 'number' || type === 'date') ? (dropsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';

                if (type === 'number') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                    if (isNaN(valA)) valA = (dropsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    if (isNaN(valB)) valB = (dropsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    return (valA - valB) * (dropsCurrentSortDirection === 'asc' ? 1 : -1);
                } else if (type === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                    if (isNaN(valA.getTime())) valA = new Date(0);
                    if (isNaN(valB.getTime())) valB = new Date(0);
                    return (valA.getTime() - valB.getTime()) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                } else { // string
                    return valA.toString().localeCompare(valB.toString()) * (pbsCurrentSortDirection === 'asc' ? 1 : -1);
                }
            });
            renderDropsTable(filteredAndSortedDrops);
        }

        function renderDropsTable(dropsToDisplay) {
            const tableBody = document.querySelector('#dropsTable tbody');
            tableBody.innerHTML = '';

            if (dropsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-400">No matching drops found.</td></tr>`;
                return;
            }

            const startIndex = (dropsCurrentPage - 1) * dropsItemsPerPage;
            const endIndex = startIndex + dropsItemsPerPage;
            const dropsToDisplayOnPage = dropsToDisplay.slice(startIndex, endIndex);

            dropsToDisplayOnPage.forEach(drop => {
                const row = document.createElement('tr');

                let statusClass = 'hover:bg-gray-800 transition-colors duration-150';
                if (drop.status_name === 'Denied') {
                    statusClass = 'bg-red-900/40 hover:bg-red-900/60 transition-colors duration-150';
                } else if (drop.status_name === 'Submitted') {
                    statusClass = 'bg-yellow-900/40 hover:bg-yellow-900/60 transition-colors duration-150';
                }
                row.className = statusClass;

                const formattedValue = formatCurrency(drop.value);
                const formattedReviewedDate = formatToDDMMYYYY(drop.reviewedDate);

                const imageUrlContent = drop.imageUrl ?
                                        `<a href="${drop.imageUrl}" target="_blank" rel="noopener noreferrer"
                                           class="text-custom-blue-400 hover:text-custom-blue-300 inline-flex items-center"
                                           title="View image">
                                            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            View
                                        </a>` :
                                        '<span class="text-gray-500">-</span>';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${drop.Id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${drop.submitter || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${drop.member_names || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${drop.notes || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedValue}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${drop.status_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${imageUrlContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedReviewedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${drop.reviewer || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('#dropsTable thead th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.dataset.column === dropsCurrentSortColumn) {
                    header.classList.add(dropsCurrentSortDirection);
                }
            });

            renderDropsPagination(dropsToDisplay.length);
        }

        function handleDropsSearch() {
            dropsCurrentPage = 1;
            applyDropsFiltersAndSort();
        }

        function sortDropsTable(column, type) {
            dropsCurrentPage = 1;
            if (dropsCurrentSortColumn === column) {
                dropsCurrentSortDirection = (dropsCurrentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                dropsCurrentSortColumn = column;
                dropsCurrentSortDirection = 'asc';
            }
            applyDropsFiltersAndSort();
        }

        function renderDropsPagination(totalItems) {
            const paginationContainer = document.getElementById('dropsPagination');
            paginationContainer.innerHTML = '';

            const totalPages = Math.ceil(totalItems / dropsItemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            const visiblePageNumbers = generatePageNumbers(dropsCurrentPage, totalPages, 6);

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.classList.add('pagination-button');
            prevButton.disabled = dropsCurrentPage === 1;
            prevButton.onclick = () => {
                if (dropsCurrentPage > 1) {
                    dropsCurrentPage--;
                    renderDropsTable(filteredAndSortedDrops);
                }
            };
            paginationContainer.appendChild(prevButton);

            visiblePageNumbers.forEach(pageNum => {
                if (pageNum === '...') {
                    const ellipsisSpan = document.createElement('span');
                    ellipsisSpan.textContent = '...';
                    ellipsisSpan.classList.add('px-3', 'py-1', 'text-gray-400');
                    paginationContainer.appendChild(ellipsisSpan);
                } else {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = pageNum;
                    pageButton.classList.add('pagination-button');
                    if (pageNum === dropsCurrentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.onclick = () => {
                        dropsCurrentPage = pageNum;
                        renderDropsTable(filteredAndSortedDrops);
                    };
                    paginationContainer.appendChild(pageButton);
                }
            });

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.classList.add('pagination-button');
            nextButton.disabled = dropsCurrentPage === totalPages;
            nextButton.onclick = () => {
                if (dropsCurrentPage < totalPages) {
                    dropsCurrentPage++;
                    renderDropsTable(filteredAndSortedDrops);
                }
            };
            paginationContainer.appendChild(nextButton);
        }

        // --- Points Table Functions ---
        function fetchPointsData() {
            applyPointsFiltersAndSort();
        }

        function applyPointsFiltersAndSort() {
            const searchTerm = document.getElementById('pointsSearchInput').value.toLowerCase();
            filteredAndSortedPoints = allPointsData.filter(point => {
                const dateForSearch = point.date ? formatToDDMMYYYY(point.date) : '';
                return Object.values(point).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                ) || dateForSearch.includes(searchTerm);
            });

            filteredAndSortedPoints.sort((a, b) => {
                let valA = a[pointsCurrentSortColumn];
                let valB = b[pointsCurrentSortColumn];

                const type = document.querySelector(`#pointsTable th[data-column="${pointsCurrentSortColumn}"]`).dataset.type;

                if (valA === null || valA === undefined) valA = (type === 'number' || type === 'date') ? (pointsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';
                if (valB === null || valB === undefined) valB = (type === 'number' || type === 'date') ? (pointsCurrentSortDirection === 'asc' ? Infinity : -Infinity) : '';

                if (type === 'number') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                    if (isNaN(valA)) valA = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    if (isNaN(valB)) valB = (pbsCurrentSortDirection === 'asc' ? Infinity : -Infinity);
                    return (valA - valB) * (pointsCurrentSortDirection === 'asc' ? 1 : -1);
                } else if (type === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                    if (isNaN(valA.getTime())) valA = new Date(0);
                    if (isNaN(valB.getTime())) valB = new Date(0);
                    return (valA.getTime() - valB.getTime()) * (pointsCurrentSortDirection === 'asc' ? 1 : -1);
                } else { // string
                    return String(valA).localeCompare(String(valB)) * (pointsCurrentSortDirection === 'asc' ? 1 : -1);
                }
            });
            renderPointsTable(filteredAndSortedPoints);
        }

        function renderPointsTable(pointsToDisplay) {
            const tableBody = document.querySelector('#pointsTable tbody');
            tableBody.innerHTML = '';

            if (pointsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">No matching points found.</td></tr>`;
                return;
            }

            const startIndex = (pointsCurrentPage - 1) * pointsItemsPerPage;
            const endIndex = startIndex + pointsItemsPerPage;
            const pointsToDisplayOnPage = pointsToDisplay.slice(startIndex, endIndex);

            pointsToDisplayOnPage.forEach(point => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                const formattedDate = formatToDDMMYYYY(point.date);
                const messageUrlContent = point.messageUrl ?
                                        `<a href="${point.messageUrl}" target="_blank" class="text-custom-blue-400 hover:underline">View Link</a>` :
                                        'N/A';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${point.Id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${point.displayName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${point.points || '0'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${point.notes || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${messageUrlContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedDate}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('#pointsTable thead th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.dataset.column === pointsCurrentSortColumn) {
                    header.classList.add(pointsCurrentSortDirection);
                }
            });

            renderPointsPagination(pointsToDisplay.length);
        }

        function sortPointsTable(column, type) {
            pointsCurrentPage = 1;
            if (pointsCurrentSortColumn === column) {
                pointsCurrentSortDirection = (pointsCurrentSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                pointsCurrentSortColumn = column;
                pointsCurrentSortDirection = 'asc';
            }
            applyPointsFiltersAndSort();
        }

        function renderPointsPagination(totalItems) {
            const paginationContainer = document.getElementById('pointsPagination');
            paginationContainer.innerHTML = '';

            const totalPages = Math.ceil(totalItems / pointsItemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            const visiblePageNumbers = generatePageNumbers(pointsCurrentPage, totalPages, 6);

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.classList.add('pagination-button');
            prevButton.disabled = pointsCurrentPage === 1;
            prevButton.onclick = () => {
                if (pointsCurrentPage > 1) {
                    pointsCurrentPage--;
                    renderPointsTable(filteredAndSortedPoints);
                }
            };
            paginationContainer.appendChild(prevButton);

            visiblePageNumbers.forEach(pageNum => {
                if (pageNum === '...') {
                    const ellipsisSpan = document.createElement('span');
                    ellipsisSpan.textContent = '...';
                    ellipsisSpan.classList.add('px-3', 'py-1', 'text-gray-400');
                    paginationContainer.appendChild(ellipsisSpan);
                } else {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = pageNum;
                    pageButton.classList.add('pagination-button');
                    if (pageNum === pointsCurrentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.onclick = () => {
                        pointsCurrentPage = pageNum;
                        renderPointsTable(filteredAndSortedPoints);
                    };
                    paginationContainer.appendChild(pageButton);
                }
            });

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.classList.add('pagination-button');
            nextButton.disabled = pointsCurrentPage === totalPages;
            nextButton.onclick = () => {
                if (pointsCurrentPage < totalPages) {
                    pointsCurrentPage++;
                    renderPointsTable(filteredAndSortedPoints);
                }
            };
            paginationContainer.appendChild(nextButton);
        }

        // --- Hall of Fame Functions ---
        async function fetchBingoWinnersData() {
            const container = document.getElementById('bingoWinnersContainer');
            try {
                const response = await fetchWithLoader(BINGOWINNERS_API_URL);
                const winners = await response.json();
                console.log('Bingo Winners Data fetched:', winners);
                renderBingoWinners(winners);
            } catch (error) {
                console.error('Error fetching bingo winners data:', error);
                container.innerHTML = `<p class="text-center text-red-500 col-span-full">Error loading winners. Please ensure the backend server is running and accessible at ${BINGOWINNERS_API_URL}.</p>`;
            }
        }

        function renderBingoWinners(winners) {
            const container = document.getElementById('bingoWinnersContainer');
            container.innerHTML = '';

            if (!winners || winners.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 col-span-full">No bingo winners found.</p>';
                return;
            }

            winners.forEach(winner => {
                const card = document.createElement('div');
                card.className = 'bg-custom-blue-900 p-6 rounded-lg shadow-lg flex flex-col';

                card.innerHTML = `
                    <h3 class="text-xl font-bold text-custom-blue-400 mb-2">${winner.bingoName}</h3>
                    <div class="flex-grow">
                        <p class="text-lg font-semibold text-white mb-3"> <span class="text-yellow-400">${winner.teamName}</span></p>
                        <div>
                            <p class="font-medium text-gray-300">Participants:</p>
                            <p class="text-sm text-gray-400 wrap-text">${winner.participants}</p>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }


        // --- Approved Stats Functions ---
        async function fetchApprovedDropsData() {
            try {
                const response = await fetchWithLoader(APPROVEDDROPS_API_URL);
                const data = await response.json();
                console.log('Approved Drops Data fetched:', data);
                renderApprovedDropsTable(data);
            } catch (error) {
                console.error('Error fetching approved drops data:', error);
                const tableBody = document.querySelector('#approvedDropsTable tbody');
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
            }
        }

        async function fetchApprovedPbsData() {
            try {
                const response = await fetchWithLoader(APPROVEDPBS_API_URL);
                const data = await response.json();
                console.log('Approved PBs Data fetched:', data);
                renderApprovedPbsTable(data);
            } catch (error) {
                console.error('Error fetching approved PBs data:', error);
                const tableBody = document.querySelector('#approvedPbsTable tbody');
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
            }
        }

        function renderApprovedDropsTable(data) {
            const tableBody = document.querySelector('#approvedDropsTable tbody');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-400">No data found.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${item['count(*)']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.displayName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.name}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderApprovedPbsTable(data) {
            const tableBody = document.querySelector('#approvedPbsTable tbody');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-400">No data found.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${item['count(*)']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.displayName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.name}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- User Profile Page Functions ---
        async function fetchUsersForDropdown() {
            NProgress.start();
            if (allUsersData.length === 0) {
                await preloadAllData();
            }
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">-- Select a User --</option>';
            const sortedUsers = [...allUsersData].sort((a, b) => {
                const nameA = a.displayName || '';
                const nameB = b.displayName || '';
                return nameA.localeCompare(nameB);
            });

            sortedUsers.forEach(user => {
                if (user.displayName) {
                    const option = document.createElement('option');
                    option.value = user.displayName;
                    option.textContent = user.displayName;
                    userSelect.appendChild(option);
                }
            });

            const hash = window.location.hash;
            const queryString = hash.split('?')[1];
            if (queryString) {
                const urlParams = new URLSearchParams(queryString);
                const userParam = urlParams.get('user');
                if (userParam) {
                    const decodedUser = decodeURIComponent(userParam);
                    if ([...userSelect.options].some(option => option.value === decodedUser)) {
                        userSelect.value = decodedUser;
                        handleUserSelection();
                    }
                }
            }
            NProgress.done();
        }

        async function handleUserSelection() {
            const userSelect = document.getElementById('userSelect');
            const selectedDisplayName = userSelect.value;

            const userDetailsSummary = document.getElementById('userDetailsSummary');
            const overallStatsSection = document.getElementById('overallStatsSection');
            const recentDropsSection = document.getElementById('recentDropsSection');
            const personalBestsProfileSection = document.getElementById('personalBestsProfileSection');


            if (selectedDisplayName) {
                NProgress.start();
                userDetailsSummary.classList.remove('hidden');
                overallStatsSection.classList.remove('hidden');
                recentDropsSection.classList.remove('hidden');
                personalBestsProfileSection.classList.remove('hidden');

                const selectedUser = allUsersData.find(user => user.displayName === selectedDisplayName);
                if (selectedUser) {
                    renderUserProfileDetails(selectedUser);
                    await fetchUserPointsTrend(selectedUser);
                    updateTotalStats(selectedDisplayName);
                    setupShareProfileButton(selectedDisplayName);
                }
                fetchUserRecentDrops(selectedDisplayName);
                currentPbView = 'recent';
                displayUserPersonalBests(selectedDisplayName);

                const newHash = `#userprofile?user=${encodeURIComponent(selectedDisplayName)}`;
                if (window.location.hash !== newHash) {
                    window.history.replaceState(null, '', newHash);
                }
                NProgress.done();

            } else {
                userDetailsSummary.classList.add('hidden');
                overallStatsSection.classList.add('hidden');
                recentDropsSection.classList.add('hidden');
                personalBestsProfileSection.classList.add('hidden');
                document.getElementById('userNameDisplay').textContent = '';
                document.getElementById('userAvatar').src = `https://placehold.co/80x80/2a608d/ffffff?text=User`;
                document.getElementById('userRankIcon').src = '';
                document.getElementById('userRankName').textContent = '';

                document.getElementById('userMainRsn').textContent = '';
                document.getElementById('userAltRsn').textContent = '';
                document.getElementById('userJoinDate').textContent = '';
                document.getElementById('userDiaryPoints').textContent = '';
                document.getElementById('userMasterDiaryPoints').textContent = '';
                document.getElementById('userPoints3Months').textContent = '';
                document.getElementById('userFlavourText').textContent = '';

                document.getElementById('totalDropsSubmitted').textContent = '0';
                document.getElementById('totalPbsSubmitted').textContent = '0';

                if (pointsTrendChartInstance) {
                    pointsTrendChartInstance.destroy();
                    pointsTrendChartInstance = null;
                }
            }
        }

        function fetchUserRecentDrops(displayName) {
             const userDrops = allDropsData
                .filter(drop => drop.submitter === displayName)
                .sort((a, b) => new Date(b.reviewedDate) - new Date(a.reviewedDate))
                .slice(0, 5);

            renderRecentDropsTable(userDrops);
        }

        function renderRecentDropsTable(drops) {
            const tableBody = document.getElementById('recentDropsTableBody');
            tableBody.innerHTML = '';

            if (drops.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">No recent drops found.</td></tr>`;
                return;
            }

            drops.forEach(drop => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                const formattedValue = formatCurrency(drop.value);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${drop.Id || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${drop.member_names || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${drop.notes || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedValue}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${drop.status_name || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function displayUserPersonalBests(displayName) {
            const titleEl = document.getElementById('personalBestsTitle');
            const toggleBtn = document.getElementById('togglePbViewBtn');

            const userPBs = allPersonalBestsData.filter(pb => pb.member_names && pb.member_names.split(',').map(name => name.trim()).includes(displayName));

            if (currentPbView === 'recent') {
                titleEl.textContent = '5 Most Recent Personal Bests';
                toggleBtn.textContent = 'Show Best Times';
                const recentPBs = userPBs
                    .sort((a, b) => new Date(b.submittedDate) - new Date(a.submittedDate))
                    .slice(0, 5);
                renderPersonalBestsProfileTable(recentPBs);
            } else { // 'best' view
                titleEl.textContent = 'Best Times';
                toggleBtn.textContent = 'Show Recent Bests';
                const bestTimes = calculateUniqueBestTimes(userPBs);
                renderPersonalBestsProfileTable(bestTimes);
            }
        }

        function calculateUniqueBestTimes(userPBs) {
            const bestTimesMap = new Map();
            userPBs.forEach(pb => {
                const key = `${pb.boss_name}-${pb.scale}`;
                const currentTimeMs = parseTimeMs(pb.time);

                if (!isNaN(currentTimeMs)) {
                    if (!bestTimesMap.has(key) || currentTimeMs < parseTimeMs(bestTimesMap.get(key).time)) {
                        bestTimesMap.set(key, pb);
                    }
                }
            });
            return Array.from(bestTimesMap.values()).sort((a, b) => {
                if (a.boss_name < b.boss_name) return -1;
                if (a.boss_name > b.boss_name) return 1;
                return (a.scale || 0) - (b.scale || 0);
            });
        }

        function renderPersonalBestsProfileTable(pbs) {
            const tableBody = document.getElementById('personalBestsProfileTableBody');
            tableBody.innerHTML = '';

            if (pbs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No personal bests found.</td></tr>`;
                return;
            }

            pbs.forEach(pb => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                const formattedTime = pb.time ? formatTimeFromMs(parseTimeMs(pb.time)) : 'N/A';
                const imageUrlContent = pb.imageUrl ?
                                        `<a href="${pb.imageUrl}" target="_blank" class="text-custom-blue-400 hover:underline">View Image</a>` :
                                        'N/A';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${pb.boss_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${pb.scale || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${imageUrlContent}</td>
                `;
                tableBody.appendChild(row);
            });
        }


        function renderUserProfileDetails(user) {
            document.getElementById('userNameDisplay').textContent = user.displayName || 'N/A';
            document.getElementById('userAvatar').src = `https://placehold.co/80x80/2a608d/ffffff?text=${user.displayName ? user.displayName.charAt(0) : 'U'}`;
            document.getElementById('userOverallPoints').textContent = user.points ? parseInt(user.points).toLocaleString('de-DE') : '0';
            const rankName = user.rank_name || 'N/A';
            document.getElementById('userRankName').textContent = rankName;
            const rankIconPath = rankName !== 'N/A' ? `/icons/${rankName.toLowerCase().replace(/\s/g, '-')}.webp` : '';
            document.getElementById('userRankIcon').src = rankIconPath;

            document.getElementById('userMainRsn').textContent = user.mainRSN || 'N/A';
            document.getElementById('userAltRsn').textContent = user.altRSN || 'N/A';
            document.getElementById('userJoinDate').textContent = formatToDDMMYYYY(user.joinDate);
            document.getElementById('userDiaryPoints').textContent = user.diaryPoints || '0';
            document.getElementById('userMasterDiaryPoints').textContent = user.masterDiaryPoints || '0';
            document.getElementById('userPoints3Months').textContent = user.points_past_3_months ? parseInt(user.points_past_3_months).toLocaleString('de-DE') : '0';
            document.getElementById('userFlavourText').textContent = user.flavourText || 'N/A';
        }

        async function fetchUserPointsTrend(selectedUser) {
             if (!selectedUser) return;
            const displayName = selectedUser.displayName;
            const overallPoints = selectedUser.points || 0;

            const userPointsHistory = allPointsDataForGraph.filter(point => point.displayName === displayName);
            const sortedPoints = userPointsHistory.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

            const trackedPointsSum = sortedPoints.reduce((sum, point) => sum + (point.points || 0), 0);
            const startingPoints = overallPoints - trackedPointsSum;

            const labels = [];
            const data = [];
            let cumulativePoints = startingPoints;

            sortedPoints.forEach(point => {
                const date = new Date(point.date);
                labels.push(`${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`);

                cumulativePoints += (point.points || 0);
                data.push(cumulativePoints);
            });

            if(data.length > 0 && data[data.length - 1] !== overallPoints) {
                console.warn(`Graph's final point (${data[data.length - 1]}) does not match overall points (${overallPoints}). Adjusting for consistency.`);
                data[data.length - 1] = overallPoints;
            }

            currentPointsDataForChart = { labels, data };
            renderPointsTrendGraph();
        }

        function renderPointsTrendGraph() {
            const ctx = document.getElementById('pointsTrendChart').getContext('2d');

            if (pointsTrendChartInstance) {
                pointsTrendChartInstance.destroy();
            }

            pointsTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentPointsDataForChart.labels,
                    datasets: [{
                        label: 'Cumulative Points',
                        data: currentPointsDataForChart.data,
                        borderColor: 'rgb(51, 184, 230)',
                        backgroundColor: 'rgba(51, 184, 230, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Points: ${parseInt(context.raw).toLocaleString('de-DE')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#a0aec0'
                            },
                            grid: {
                                color: '#4a5568'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#a0aec0',
                                callback: function(value) {
                                    return parseInt(value).toLocaleString('de-DE');
                                }
                            },
                            grid: {
                                color: '#4a5568'
                            }
                        }
                    }
                }
            });
        }


        function updateTotalStats(displayName) {
            const userDropsCount = allDropsData.filter(drop => drop.submitter === displayName).length;
            document.getElementById('totalDropsSubmitted').textContent = userDropsCount;

            const userPBs = allPersonalBestsData.filter(pb => {
                return pb.member_names && pb.member_names.split(',').map(name => name.trim()).includes(displayName);
            });

            const bestTimesMap = new Map();
            userPBs.forEach(pb => {
                const key = `${pb.boss_name}-${pb.scale}`;
                const currentTimeMs = parseTimeMs(pb.time);
                if (!isNaN(currentTimeMs)) {
                    if (!bestTimesMap.has(key) || currentTimeMs < parseTimeMs(bestTimesMap.get(key).time)) {
                        bestTimesMap.set(key, pb);
                    }
                }
            });
            const uniqueBestPBsCount = Array.from(bestTimesMap.values()).length;
            document.getElementById('totalPbsSubmitted').textContent = uniqueBestPBsCount;
        }


        function setupShareProfileButton(displayName) {
            const shareButton = document.getElementById('shareProfileButton');
            const copyFeedback = document.getElementById('copyFeedback');

            shareButton.onclick = () => {
                const profileLink = `${window.location.origin}${window.location.pathname}#userprofile?user=${encodeURIComponent(displayName)}`;

                const textArea = document.createElement('textarea');
                textArea.value = profileLink;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        copyFeedback.textContent = 'Profile link copied to clipboard!';
                        copyFeedback.classList.remove('hidden');
                        copyFeedback.classList.add('text-green-400');
                        setTimeout(() => copyFeedback.classList.add('hidden'), 3000);
                    } else {
                        throw new Error('Copy command failed');
                    }
                } catch (err) {
                    navigator.clipboard.writeText(profileLink).then(() => {
                        copyFeedback.textContent = 'Profile link copied to clipboard!';
                        copyFeedback.classList.remove('hidden');
                        copyFeedback.classList.add('text-green-400');
                        setTimeout(() => copyFeedback.classList.add('hidden'), 3000);
                    }).catch(error => {
                        console.error('Failed to copy text: ', error);
                        copyFeedback.textContent = 'Failed to copy link. Please copy manually: ' + profileLink;
                        copyFeedback.classList.remove('hidden');
                        copyFeedback.classList.add('text-red-400');
                        setTimeout(() => copyFeedback.classList.add('hidden'), 5000);
                    });
                } finally {
                    document.body.removeChild(textArea);
                }
            };
        }

        function generateImageUrlContent(imageUrl) {
            return imageUrl ?
                `<a href="${imageUrl}" target="_blank" rel="noopener noreferrer"
                   class="text-custom-blue-400 hover:text-custom-blue-300 inline-flex items-center"
                   title="View image">
                    <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    View
                </a>` :
                '<span class="text-gray-500">-</span>';
        }

        // PB Hiscores Functions
        let bossImages = [];
        let uniqueBosses = new Set();
        let uniqueScales = new Set();
        let currentPage = 1;
        const itemsPerPage = 200;

        async function fetchBossImages() {
            try {
                const response = await fetchWithLoader('/api/bossImages');
                if (!response.ok) throw new Error('Failed to fetch boss images');
                bossImages = await response.json();
                return bossImages;
            } catch (error) {
                console.error('Error fetching boss images:', error);
                return [];
            }
        }

        function extractUniqueBossesAndScales(personalBests) {
            uniqueBosses.clear();
            uniqueScales.clear();

            personalBests.forEach(pb => {
                if (pb.boss_name) uniqueBosses.add(pb.boss_name);
                if (pb.scale) uniqueScales.add(pb.scale);
            });

            uniqueBosses = new Set([...uniqueBosses].sort());
            uniqueScales = new Set([...uniqueScales].sort((a, b) => a - b));
        }

        function createFilterUI() {
            const container = document.getElementById('pbHiscoresContainer');
            container.innerHTML = `
                <div class="mb-6 bg-gray-800 p-4 rounded-lg">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="bossFilter" class="block text-sm font-medium text-gray-300 mb-1">Select Boss</label>
                            <select id="bossFilter" class="w-full px-3 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-400">
                                <option value="">All Bosses</option>
                                ${[...uniqueBosses].map(boss =>
                                    `<option value="${boss}">${boss}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="scaleFilter" class="block text-sm font-medium text-gray-300 mb-1">Select Scale</label>
                            <select id="scaleFilter" class="w-full px-3 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue-400">
                                <option value="">All Scales</option>
                                ${[...uniqueScales].sort((a, b) => a - b).map(scale =>
                                    `<option value="${scale}">${scale} Player${scale > 1 ? 's' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="bossImageContainer" class="mb-6 flex justify-center items-center bg-gray-900 rounded-lg overflow-hidden" style="height: 150px;">
                        <p class="text-gray-500">Select a boss to view image</p>
                    </div>
                </div>
                <div id="pbHiscoresTableContainer"></div>
                <div id="paginationContainer"></div>
            `;

            document.getElementById('bossFilter').addEventListener('change', updatePbHiscores);
            document.getElementById('scaleFilter').addEventListener('change', updatePbHiscores);
        }

        function updateBossImage(bossName) {
            const container = document.getElementById('bossImageContainer');
            if (!bossName) {
                container.innerHTML = '<p class="text-gray-500">Select a boss to view image</p>';
                return;
            }

            let boss = bossImages.find(b => b.name === bossName);

            if (!boss) {
                boss = bossImages.find(b => bossName.startsWith(b.name) || b.name.startsWith(bossName));
            }

            if (!boss || !boss.imageUrl) {
                container.innerHTML = `<p class="text-gray-500">No image available for ${bossName}</p>`;
                return;
            }

            container.innerHTML = `
                <img src="${boss.imageUrl}" alt="${bossName}"
                     class="max-w-full max-h-full object-contain"
                     onerror="this.parentElement.innerHTML='<p class=\'text-gray-500\'>Failed to load image</p>'">
            `;
        }

        function filterPersonalBests(personalBests, bossFilter, scaleFilter) {
            return personalBests.filter(pb => {
                const matchesBoss = !bossFilter || pb.boss_name === bossFilter;
                const matchesScale = !scaleFilter || String(pb.scale) === scaleFilter;
                return matchesBoss && matchesScale;
            });
        }

        function groupAndSortPBs(personalBests) {
            const scaleFilter = document.getElementById('scaleFilter')?.value;
            const isAllScales = scaleFilter === 'All' || !scaleFilter;

            const userBestTimes = personalBests.reduce((acc, pb) => {
                const userKey = isAllScales
                    ? `${pb.boss_name || 'Unknown'}|${pb.member_names || 'Unknown'}`
                    : `${pb.boss_name || 'Unknown'}|${pb.scale || 'Solo'}|${pb.member_names || 'Unknown'}`;

                const timeMs = parseTimeMs(pb.time);

                if (!acc[userKey] || timeMs < acc[userKey].timeMs) {
                    acc[userKey] = {
                        ...pb,
                        timeMs: timeMs
                    };
                }
                return acc;
            }, {});

            const bestTimes = Object.values(userBestTimes);

            const grouped = bestTimes.reduce((acc, pb) => {
                const key = isAllScales
                    ? `${pb.boss_name || 'Unknown'}`
                    : `${pb.boss_name || 'Unknown'}|${pb.scale || 'Solo'}`;

                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(pb);
                return acc;
            }, {});

            Object.values(grouped).forEach(group => {
                group.sort((a, b) => a.timeMs - b.timeMs);
            });

            return grouped;
        }

        function renderPagination(totalItems, currentPage, itemsPerPage, containerId) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return '';

            let paginationHtml = `
                <div class="flex items-center justify-between mt-4 px-4 py-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">
                        Showing <span class="font-medium">${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)}</span> to
                        <span class="font-medium">${Math.min(currentPage * itemsPerPage, totalItems)}</span> of
                        <span class="font-medium">${totalItems}</span> results
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="changePbPage(${Math.max(1, currentPage - 1)})"
                                class="px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                ${currentPage === 1 ? 'disabled' : ''}>
                            Previous
                        </button>
                        ${Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                            let pageNum;
                            if (totalPages <= 5) {
                                pageNum = i + 1;
                            } else if (currentPage <= 3) {
                                pageNum = i + 1;
                            } else if (currentPage >= totalPages - 2) {
                                pageNum = totalPages - 4 + i;
                            } else {
                                pageNum = currentPage - 2 + i;
                            }
                            return `
                                <button onclick="changePbPage(${pageNum})"
                                        class="px-3 py-1 rounded ${currentPage === pageNum ? 'bg-custom-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                    ${pageNum}
                                </button>`;
                        }).join('')}
                        <button onclick="changePbPage(${Math.min(totalPages, currentPage + 1)})"
                                class="px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                ${currentPage === totalPages ? 'disabled' : ''}>
                            Next
                        </button>
                    </div>
                </div>`;

            const paginationContainer = document.getElementById(containerId);
            if (paginationContainer) {
                paginationContainer.innerHTML = paginationHtml;
            }

            return paginationHtml;
        }

        function renderPbHiscoresTable(personalBests) {
            const container = document.getElementById('pbHiscoresTableContainer');
            if (!personalBests || personalBests.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-400">No personal bests found matching the selected filters.</p>';
                document.getElementById('paginationContainer')?.remove();
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedPBs = personalBests.slice(startIndex, endIndex);

            const groupedPBs = groupAndSortPBs(paginatedPBs);
            const scaleFilter = document.getElementById('scaleFilter')?.value;
            const isAllScales = scaleFilter === 'All' || !scaleFilter;

            container.innerHTML = Object.entries(groupedPBs).map(([key, pbs]) => {
                const [bossName, scale] = key.split('|');
                const title = isAllScales
                    ? `${bossName}`
                    : `${bossName} (${scale} Player${scale !== '1' ? 's' : ''})`;

                return `
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-custom-blue-400 mb-3">${title}</h3>
                        <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                            <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-12">#</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Players</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider w-20">Scale</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-24">Time</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-28">Date</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider w-16">Image</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    ${pbs.map((pb, index) => `
                                        <tr class="hover:bg-gray-800 transition-colors duration-150">
                                            <td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-200 text-center w-12">
                                                ${index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : index + 1}
                                            </td>
                                            <td class="px-3 py-3 text-sm text-gray-300 wrap-text max-w-[256px] truncate" title="${pb.member_names || 'N/A'}">
                                                ${pb.member_names || 'N/A'}
                                            </td>
                                            <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-300 text-center w-20">
                                                ${pb.scale || '1'} Player${pb.scale !== '1' ? 's' : ''}
                                            </td>
                                            <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-300 text-center w-28">${formatTimeFromMs(parseTimeMs(pb.time))}</td>
                                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-300 text-center w-32">${formatToDDMMYYYY(pb.submittedDate)}</td>
                                            <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-300 text-center w-16">
                                                ${pb.imageUrl ?
                                                    `<a href="${pb.imageUrl}" target="_blank" rel="noopener noreferrer"
                                                       class="inline-flex items-center justify-center text-custom-blue-400 hover:text-custom-blue-300"
                                                       title="View image">
                                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                    </a>` :
                                                    '<span class="text-gray-500">-</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updatePbHiscores() {
            NProgress.start();
            const bossFilter = document.getElementById('bossFilter').value;
            const scaleFilter = document.getElementById('scaleFilter').value;

            if (bossFilter) {
                updateBossImage(bossFilter);
            } else {
                updateBossImage(null);
            }

            const filteredPBs = filterPersonalBests(allPersonalBestsData, bossFilter, scaleFilter);
            renderPbHiscoresTable(filteredPBs);

            if (filteredPBs.length > itemsPerPage) {
                renderPagination(filteredPBs.length, currentPage, itemsPerPage, 'paginationContainer');
            } else {
                const paginationContainer = document.getElementById('paginationContainer');
                if (paginationContainer) {
                    paginationContainer.innerHTML = '';
                }
            }
            NProgress.done();
        }

        async function fetchPbHiscoresData() {
            const container = document.getElementById('pbHiscoresContainer');
            container.innerHTML = '<p class="text-center py-8 text-gray-400">Loading PB hiscores...</p>';
            currentPage = 1;
            NProgress.start();

            try {
                await fetchBossImages();
                extractUniqueBossesAndScales(allPersonalBestsData);
                createFilterUI();
                await updatePbHiscores();

            } catch (error) {
                console.error('Error initializing PB Hiscores:', error);
                container.innerHTML = `
                    <div class="bg-red-900/50 border border-red-700 text-red-200 p-4 rounded-lg">
                        <p class="font-semibold">Error loading PB Hiscores</p>
                        <p class="text-sm mt-1">${error.message || 'Please try again later.'}</p>
                    </div>
                `;
            } finally {
                NProgress.done();
            }
        }

        function renderPbHiscores(personalBests) {
            const container = document.getElementById('pbHiscoresContainer');
            container.innerHTML = '';

            if (!personalBests || personalBests.length === 0) {
                container.innerHTML = '<p class="text-center py-4 text-gray-400">No personal bests data available to generate hiscores.</p>';
                return;
            }

            const groupedPBs = personalBests.reduce((acc, pb) => {
                const key = `${pb.boss_name || 'Unknown'}-${pb.scale || 'Solo'}`;
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(pb);
                return acc;
            }, {});

            for (const key in groupedPBs) {
                groupedPBs[key].sort((a, b) => {
                    const timeA = parseTimeMs(a.time);
                    const timeB = parseTimeMs(b.time);
                    return timeA - timeB;
                });
                groupedPBs[key] = groupedPBs[key].slice(0, 5);
            }

            const sortedGroupKeys = Object.keys(groupedPBs).sort();
            if (sortedGroupKeys.length === 0) {
                 container.innerHTML = '<p class="text-center py-4 text-gray-400">No personal bests data available to generate hiscores.</p>';
                 return;
            }

            sortedGroupKeys.forEach(key => {
                const pbsInGroup = groupedPBs[key];
                if (pbsInGroup.length === 0) return;

                const groupTitle = document.createElement('h2');
                groupTitle.className = 'text-2xl font-bold text-custom-blue-400 mt-8 mb-4 border-b border-gray-700 pb-2';
                groupTitle.textContent = `${pbsInGroup[0].boss_name} (Scale: ${pbsInGroup[0].scale})`;
                container.appendChild(groupTitle);

                const tableContainer = document.createElement('div');
                tableContainer.className = 'overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm mb-8';

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Player(s)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Submitted Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        ${pbsInGroup.map((pb, index) => `
                            <tr class="hover:bg-gray-800 transition-colors duration-150">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${index + 1}</td>
                                <td class="px-6 py-4 text-sm text-gray-300 wrap-text">${pb.member_names || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatTimeFromMs(parseTimeMs(pb.time))}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatToDDMMYYYY(pb.submittedDate)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    ${pb.imageUrl ?
                                        `<a href="${pb.imageUrl}" target="_blank" rel="noopener noreferrer"
                                           class="text-custom-blue-400 hover:text-custom-blue-300"
                                           title="View image">
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </a>` :
                                        '<span class="text-gray-500">-</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                tableContainer.appendChild(table);
                container.appendChild(tableContainer);
            });
        }


        // --- Diary Times & Rewards Functions ---
        function fetchDiaryTimesData() {
            renderDiaryTimesTable();
            renderDiaryRewardsTable();
        }

        function renderDiaryTimesTable() {
            const tableBody = document.getElementById('diaryTimesTableBody');
            tableBody.innerHTML = '';

            if (allDiaryTimesData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">No diary times data available.</td></tr>`;
                return;
            }

            allDiaryTimesData.sort((a,b) => {
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return a.scale - b.scale;
            });

            allDiaryTimesData.forEach(diary => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-150';

                row.innerHTML = `
                    <td class="px-4 py-2 font-bold">${diary.name} - ${diary.scale} man</td>
                    <td class="px-4 py-2">${diary.timeEasy || 'N/A'}</td>
                    <td class="px-4 py-2">${diary.timeMedium || 'N/A'}</td>
                    <td class="px-4 py-2">${diary.timeHard || 'N/A'}</td>
                    <td class="px-4 py-2">${diary.timeElite || 'N/A'}</td>
                    <td class="px-4 py-2">${diary.timeMaster || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderDiaryRewardsTable() {
            const tableBody = document.getElementById('diaryRewardsTableBody');
            tableBody.innerHTML = '';

            if (allDiaryTimesData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No diary rewards data available.</td></tr>`;
                return;
            }

            let maxPossiblePoints = 0;
            allDiaryTimesData.forEach(diary => {
                if (diary.maxDifficulty >= 1) maxPossiblePoints += 1;
                if (diary.maxDifficulty >= 2) maxPossiblePoints += 2;
                if (diary.maxDifficulty >= 3) maxPossiblePoints += 3;
                if (diary.maxDifficulty >= 4) maxPossiblePoints += 4;
                if (diary.maxDifficulty >= 5) maxPossiblePoints += 5;
            });

            const rewards = [
                { task: 'Easy Task', difficultyPoints: 1, tierPercentage: 0.10, clanPoints: 50 },
                { task: 'Medium Task', difficultyPoints: 2, tierPercentage: 0.25, clanPoints: 150 },
                { task: 'Hard Task', difficultyPoints: 3, tierPercentage: 0.50, clanPoints: 250 },
                { task: 'Elite Task', difficultyPoints: 4, tierPercentage: 0.75, clanPoints: 500 },
                { task: 'Master Task', difficultyPoints: 5, tierPercentage: 1.00, clanPoints: 1000 }
            ];

            let cumulativePointsAchieved = 0;
            rewards.forEach(reward => {
                cumulativePointsAchieved += reward.difficultyPoints;
                const tierPoints = Math.round(maxPossiblePoints * reward.tierPercentage);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">${reward.task}</td>
                    <td class="px-6 py-4">+${reward.difficultyPoints}</td>
                    <td class="px-6 py-4">Tier ${rewards.indexOf(reward) + 1} (${tierPoints}/${maxPossiblePoints})</td>
                    <td class="px-6 py-4">${reward.clanPoints}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- General Page Navigation and Initialization ---

        // FIX: Moved showPage and changePbPage to the global scope
        function changePbPage(page) {
            currentPage = page;
            updatePbHiscores();
            document.getElementById('pbHiscoresTableContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function showPage(pageId) {
            console.log(`Navigating to page: ${pageId}`);
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');

                if (pageId === 'users') {
                    fetchUsersData();
                } else if (pageId === 'personalbests') {
                    fetchPersonalBestsData();
                } else if (pageId === 'drops') {
                    fetchDropsData();
                } else if (pageId === 'points') {
                    fetchPointsData();
                } else if (pageId === 'halloffame') {
                    await fetchBingoWinnersData();
                } else if (pageId === 'approved-stats') {
                    await Promise.all([fetchApprovedDropsData(), fetchApprovedPbsData()]);
                } else if (pageId === 'userprofile') {
                    await fetchUsersForDropdown();
                } else if (pageId === 'pbhiscores') {
                    await fetchPbHiscoresData();
                } else if (pageId === 'diary') {
                    fetchDiaryTimesData();
                }
            } else {
                console.warn(`Page with ID ${pageId}-page not found. Displaying home page.`);
                document.getElementById('home-page').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM content loaded. Attaching event listeners and preloading data.');

            await preloadAllData();

            // Attach event listeners for Users table search and sort
            const usersSearchInput = document.getElementById('searchInput');
            if (usersSearchInput) {
                usersSearchInput.addEventListener('keyup', handleUsersSearch);
            }
            document.querySelectorAll('#usersTable thead th.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    sortUsersTable(header.dataset.column);
                });
            });

            // Attach event listeners for Personal Bests search and sort
            const pbsSearchInput = document.getElementById('personalBestsSearchInput');
            if (pbsSearchInput) {
                pbsSearchInput.addEventListener('keyup', () => {
                    pbsCurrentPage = 1;
                    applyPersonalBestsFiltersAndSort();
                });
            }

            document.querySelectorAll('#personalBestsTable thead th.sortable').forEach(header => {
                header.addEventListener('click', (event) => {
                    const headerElement = event.currentTarget;
                    const column = headerElement.dataset.column;
                    const type = headerElement.dataset.type;
                    sortPersonalBestsTable(column, type);
                });
            });

            // Attach event listeners for Drops search and sort
            const dropsSearchInput = document.getElementById('dropsSearchInput');
            if (dropsSearchInput) {
                dropsSearchInput.addEventListener('keyup', handleDropsSearch);
            }

            document.querySelectorAll('#dropsTable thead th.sortable').forEach(header => {
                header.addEventListener('click', (event) => {
                    const headerElement = event.currentTarget;
                    const column = headerElement.dataset.column;
                    const type = headerElement.dataset.type;
                    sortDropsTable(column, type);
                });
            });

            // Attach event listeners for Points search and sort
            const pointsSearchInput = document.getElementById('pointsSearchInput');
            if (pointsSearchInput) {
                pointsSearchInput.addEventListener('keyup', () => {
                    pointsCurrentPage = 1;
                    applyPointsFiltersAndSort();
                });
            }

            document.querySelectorAll('#pointsTable thead th.sortable').forEach(header => {
                header.addEventListener('click', (event) => {
                    const headerElement = event.currentTarget;
                    const column = headerElement.dataset.column;
                    const type = headerElement.dataset.type;
                    sortPointsTable(column, type);
                });
            });

            const userSelect = document.getElementById('userSelect');
            if (userSelect) {
                userSelect.addEventListener('change', handleUserSelection);
            }

            const togglePbBtn = document.getElementById('togglePbViewBtn');
            if (togglePbBtn) {
                togglePbBtn.addEventListener('click', () => {
                    currentPbView = (currentPbView === 'recent') ? 'best' : 'recent';
                    const selectedDisplayName = document.getElementById('userSelect').value;
                    if (selectedDisplayName) {
                        displayUserPersonalBests(selectedDisplayName);
                    }
                });
            }

            const initialPageId = window.location.hash ? window.location.hash.substring(1).split('?')[0] : 'home';
            showPage(initialPageId);
        });


        window.addEventListener('hashchange', () => {
            const pageId = window.location.hash.substring(1).split('?')[0];
            if (pageId) {
                showPage(pageId);
            }
        });
    </script>
</body>
</html>
