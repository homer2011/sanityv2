<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanity Bingo</title>
    <link rel="icon" type="image/x-icon" href="/favico.ico">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- NProgress for Loading Bar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #122a3d;
            color: #e2e8f0;
        }
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1a364d; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #224b6d; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #2a608d; }
        #nprogress .bar { background: #00a3d1 !important; height: 5px !important; }
        #nprogress .peg { box-shadow: 0 0 10px #00a3d1, 0 0 7px #00a3d1 !important; }
        #nprogress .spinner-icon { border-top-color: #00a3d1 !important; border-left-color: #00a3d1 !important; }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 0.5rem;
            aspect-ratio: 1 / 1;
        }
        .bingo-tile {
            background-color: #1a364d;
            border: 1px solid #224b6d;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.5rem;
            position: relative;
            transition: all 0.2s ease-in-out;
            overflow: hidden; /* Prevent content from breaking tile dimensions */
        }
        .bingo-tile-link {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            height: 100%;
            text-decoration: none;
            color: inherit;
            position: relative;
        }
         .bingo-tile-link:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease-in-out;
        }
        .bingo-tile.completed {
            background-color: #2a608d;
            border-color: #00a3d1;
        }
        .bingo-tile img {
            width: 50%;
            height: auto;
            margin-bottom: 0.5rem;
        }
        .bingo-bonus-tile {
            background-color: #122a3d;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #224b6d;
            border-radius: 9999px;
            height: 1rem;
            margin-top: 0.5rem;
        }
        .progress-bar {
            background-color: #00a3d1;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .tile-subtext {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(26, 54, 77, 0.9);
            color: #e2e8f0;
            padding: 0.25rem;
            font-size: 0.75rem;
            line-height: 1rem;
            border-radius: 0 0 0.4rem 0.4rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }
        .bingo-tile-link:hover .tile-subtext {
            opacity: 1;
            visibility: visible;
        }
        /* Helper class to hide pages */
        .page-hidden {
            display: none;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': { 100: '#e0f3f8', 200: '#b3e1f0', 300: '#66c9ef', 400: '#33b8e6', 500: '#00a3d1', 600: '#2a608d', 700: '#224b6d', 800: '#1a364d', 900: '#122a3d' },
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-custom-blue-800 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold">
                <a href="#" class="hover:text-custom-blue-300 transition-colors duration-200">Sanity Bingo</a>
            </div>
            <div>
                <a href="#page=dropLog" id="navDropLog" class="nav-link px-4 py-2 hover:bg-custom-blue-700 rounded-md transition-colors">Drop Log</a>
                <a href="#page=teamProgress" id="navTeamProgress" class="nav-link px-4 py-2 bg-custom-blue-600 rounded-md transition-colors">Team Progress</a>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Drop Log Page Content -->
        <section id="dropLogPage" class="page-hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 id="dropLogTitle" class="text-3xl font-bold text-custom-blue-400 mb-6 text-center">Bingo Drop Log</h1>
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="Search by drop, player, or team..." class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-custom-blue-500">
                </div>
                <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                    <table id="bingoDropsTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Drop ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Submitter</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Team</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Drop Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Points</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                            </tr>
                        </thead>
                        <tbody id="bingoDropsTableBody" class="divide-y divide-gray-700">
                            <tr><td colspan="7" class="text-center py-8 text-gray-400">Loading drop log...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Team Progress Page Content -->
        <section id="teamProgressPage">
             <div class="flex justify-center items-center mb-6">
                <label for="teamSelector" class="mr-4 text-lg font-medium text-white">View Progress For:</label>
                <select id="teamSelector" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-custom-blue-500">
                    <option>Loading teams...</option>
                </select>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 flex flex-col gap-8">
                    <!-- Team Stats Section -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h1 id="teamStatsTitle" class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">Team Stats</h1>
                        <table class="min-w-full text-lg text-gray-200">
                            <tbody class="divide-y divide-gray-700">
                                <tr>
                                    <td class="py-2 font-medium">Total Points</td>
                                    <td id="teamTotalPoints" class="py-2 text-right font-bold">...</td>
                                </tr>
                                <tr>
                                    <td class="py-2 font-medium">Partial Points</td>
                                    <td id="teamPartialPoints" class="py-2 text-right font-bold">...</td>
                                </tr>
                                <tr>
                                    <td class="py-2 font-medium">Tiles Done</td>
                                    <td id="teamTilesDone" class="py-2 text-right font-bold">...</td>
                                </tr>
                                <tr>
                                    <td class="py-2 font-medium">Total Team EHB</td>
                                    <td id="teamTotalEhb" class="py-2 text-right font-bold">...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- EHB Rankings Section -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h1 class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">EHB Rankings</h1>
                        <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm">
                            <table id="ehbRankingsTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rank</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Player</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">EHB</th>
                                    </tr>
                                </thead>
                                <tbody id="ehbRankingsTableBody" class="divide-y divide-gray-700">
                                    <tr><td colspan="3" class="text-center py-8 text-gray-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Team Boss KC Section -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h1 class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">Team Boss KC</h1>
                        <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm" style="max-height: 400px;">
                            <table id="teamKcTable" class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Boss</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total KC</th>
                                    </tr>
                                </thead>
                                <tbody id="teamKcTableBody" class="divide-y divide-gray-700">
                                    <tr><td colspan="2" class="text-center py-8 text-gray-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <div class="lg:col-span-2">
                     <div class="bg-gray-800 p-6 rounded-lg shadow-md h-full">
                        <h1 class="text-3xl font-bold text-custom-blue-400 mb-6 text-center">Bingo Board</h1>
                        <div id="bingoBoardContainer" class="bingo-grid mx-auto" style="max-width: 800px;">
                             <div class="text-center py-8 text-gray-400 col-span-6">Loading bingo board...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Player Stats Page Content -->
        <section id="playerStatsPage" class="page-hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 id="playerStatsTitle" class="text-3xl font-bold text-custom-blue-400 mb-6 text-center">Player Stats</h1>

                <!-- Player Summary Stats -->
                <div id="playerSummaryStats" class="bg-gray-900 p-4 rounded-lg mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-gray-400 text-sm uppercase font-semibold">Total Drops (Event)</p>
                        <p id="playerTotalDrops" class="text-2xl font-bold text-custom-blue-300">0</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm uppercase font-semibold">Total EHB (Event)</p>
                        <p id="playerTotalEhb" class="text-2xl font-bold text-custom-blue-300">0.00</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Submitted Drops</h2>
                        <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm" style="max-height: 400px;">
                            <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Drop Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                                    </tr>
                                </thead>
                                <tbody id="playerDropsTableBody" class="divide-y divide-gray-700">
                                    <!-- Player drops will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Boss Kills & EHB</h2>
                        <div class="overflow-x-auto table-container rounded-lg border border-gray-700 shadow-sm" style="max-height: 400px;">
                            <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-200">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Boss</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">KC</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">EHB</th>
                                    </tr>
                                </thead>
                                <tbody id="playerBossKcTableBody" class="divide-y divide-gray-700">
                                    <!-- Player boss KC will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h2 class="text-2xl font-bold text-custom-blue-400 mb-4">Top 10 EHB Contributions</h2>
                        <div id="ehbChartContainer" class="bg-gray-900 p-4 rounded-lg">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-custom-blue-800 text-white text-center p-4 shadow-inner mt-8">
        <p>&copy; 2025 Sanity OSRS clan</p>
    </footer>

    <script>
        // --- NProgress Configuration ---
        NProgress.configure({ showSpinner: false });

        // --- Global Data Stores ---
        const appData = {
            processedBingoDrops: [],
            tileItemsMap: new Map(),
            teams: [],
            boardData: [],
            isDataInitialized: false,
            activeEvent: null,
            activeEventStartDate: null,
            activeEventEndDate: null,
        };

        // --- API URLs ---
        const API_BASE = 'https://sanityosrs.com/api';
        const TEAMMEMBERS_API_URL = `${API_BASE}/bingo/teammembers`;
        const RSN_KC_API_URL = `${API_BASE}/getRSNkc`;
        const BOSS_EHB_API_URL = `${API_BASE}/bingo/bossehb`;
        const BOARD_API_URL = `${API_BASE}/bingo/board`;
        const TILE_ITEMS_API_URL = `${API_BASE}/bingo/tileitems`;
        const RAID_ITEM_VALUES_API_URL = `${API_BASE}/bingo/raiditemvalues`;
        const DROPS_API_URL = `${API_BASE}/drops`;
        const BINGO_TEAMS_API_URL = `${API_BASE}/bingo/teams`;
        const EVENTS_API_URL = `${API_BASE}/bingo/events`;

        // --- Wrapper for fetch to show loading bar ---
        async function fetchWithLoader(url, options) {
            NProgress.start();
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                return await response.json();
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                throw error;
            } finally {
                NProgress.done();
            }
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('page-hidden');
            });
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.remove('page-hidden');
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-custom-blue-600');
            });

            if (pageId === 'dropLogPage') {
                document.getElementById('navDropLog').classList.add('bg-custom-blue-600');
            } else if (pageId === 'teamProgressPage') {
                document.getElementById('navTeamProgress').classList.add('bg-custom-blue-600');
            }
        }

        // --- Utility Functions ---
        function formatToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            const dateObj = new Date(dateString);
            if (isNaN(dateObj.getTime())) return 'N/A';
            return `${String(dateObj.getDate()).padStart(2, '0')}.${String(dateObj.getMonth() + 1).padStart(2, '0')}.${dateObj.getFullYear()}`;
        }

        function formatCurrency(value) {
            return (typeof value === 'number' && !isNaN(value)) ? value.toLocaleString('en-US') : '0';
        }

        function generateImageUrlContent(imageUrl) {
            if (!imageUrl) return '<span class="text-gray-500">-</span>';
            return `<a href="${imageUrl}" target="_blank" rel="noopener noreferrer"
                       class="text-custom-blue-400 hover:text-custom-blue-300 inline-flex items-center"
                       title="View image">
                        <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        View
                    </a>`;
        }

        // --- Drop Log Logic ---
        function applySearchFilterAndRender(filterParams = {}) {
            let dropsToFilter = appData.processedBingoDrops;
            const isGeneralLogView = !filterParams.tileId;

            if (isGeneralLogView && appData.activeEventStartDate && appData.activeEventEndDate) {
                 dropsToFilter = dropsToFilter.filter(drop => {
                    const dropDate = new Date(drop.reviewedDate);
                    return dropDate >= appData.activeEventStartDate && dropDate <= appData.activeEventEndDate;
                });
                if (appData.activeEvent) {
                    document.getElementById('dropLogTitle').textContent = `${appData.activeEvent.name} Drop Log`;
                }
            } else if (filterParams.tileId && appData.activeEventStartDate && appData.activeEventEndDate) {
                 dropsToFilter = dropsToFilter.filter(drop => {
                    const dropDate = new Date(drop.reviewedDate);
                    return dropDate >= appData.activeEventStartDate && dropDate <= appData.activeEventEndDate;
                });
                if (appData.activeEvent) {
                    document.getElementById('dropLogTitle').textContent = `Event Drops for Tile`;
                }
            }

            if (filterParams.teamId) {
                dropsToFilter = dropsToFilter.filter(drop => drop.teamId === filterParams.teamId);
            }

            if (filterParams.tileId) {
                const allowedItems = appData.tileItemsMap.get(filterParams.tileId) || [];
                dropsToFilter = dropsToFilter.filter(drop => {
                    const dropName = (drop.notes || '').toLowerCase();
                    return allowedItems.includes(dropName);
                });
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                dropsToFilter = dropsToFilter.filter(drop =>
                    (drop.submitter || '').toLowerCase().includes(searchTerm) ||
                    (drop.teamName || '').toLowerCase().includes(searchTerm) ||
                    (drop.notes || '').toLowerCase().includes(searchTerm)
                );
            }
            renderBingoDropLog(dropsToFilter);
        }

        function renderBingoDropLog(dropsToRender) {
            const tableBody = document.getElementById('bingoDropsTableBody');
            tableBody.innerHTML = '';

            if (!dropsToRender || dropsToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">No matching drops found.</td></tr>';
                return;
            }

            dropsToRender.sort((a, b) => new Date(b.reviewedDate) - new Date(a.reviewedDate));

            dropsToRender.forEach(drop => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-800 transition-colors align-middle';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${drop.Id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatToDDMMYYYY(drop.reviewedDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${drop.submitter || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${drop.teamName || 'N/A'}</td>
                    <td class="px-6 py-4">${drop.notes || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(drop.points)}</td>
                    <td class="px-6 py-4 text-center">${generateImageUrlContent(drop.imageUrl)}</td>
                `;
            });
        }

        // --- EHB & KC Calculation and Rendering ---
        async function initializeEhbAndKcRankings(teamId) {
            try {
                const [allTeamMembers, allKcData, bossEhbData] = await Promise.all([
                    fetchWithLoader(TEAMMEMBERS_API_URL),
                    fetchWithLoader(RSN_KC_API_URL),
                    fetchWithLoader(BOSS_EHB_API_URL)
                ]);

                const teamMembers = allTeamMembers.filter(member => member.team_id === teamId);
                const ehbMap = new Map(bossEhbData.map(b => [b.boss.toLowerCase().replace(/ /g, '_'), parseFloat(b.ehb)]));
                const kcMap = new Map(allKcData.map(p => [p.RSN.toLowerCase(), p]));

                const playerEhb = [];
                const teamKc = {};

                teamMembers.forEach(member => {
                    let totalPlayerEhb = 0;
                    const rsns = [member.mainRSN, member.altRSN].filter(Boolean).map(rsn => rsn.toLowerCase());

                    rsns.forEach(rsn => {
                        const playerData = kcMap.get(rsn);
                        if (playerData) {
                            for (const boss in playerData) {
                                if (boss !== 'RSN' && typeof playerData[boss] === 'number' && playerData[boss] > 0) {
                                    // Aggregate Team KC
                                    if (!teamKc[boss]) teamKc[boss] = 0;
                                    teamKc[boss] += playerData[boss];

                                    // Calculate Player EHB
                                    const ehbRate = ehbMap.get(boss.toLowerCase());
                                    if (ehbRate && ehbRate > 0) {
                                        totalPlayerEhb += playerData[boss] / ehbRate;
                                    }
                                }
                            }
                        }
                    });
                    playerEhb.push({ displayName: member.displayName, ehb: totalPlayerEhb });
                });

                playerEhb.sort((a, b) => b.ehb - a.ehb);
                renderEhbTable(playerEhb);
                renderTeamKcTable(teamKc);

                const totalTeamEhb = playerEhb.reduce((sum, player) => sum + player.ehb, 0);
                document.getElementById('teamTotalEhb').textContent = totalTeamEhb.toFixed(2);

            } catch (error) {
                console.error("Failed to initialize EHB & KC rankings:", error);
                document.getElementById('ehbRankingsTableBody').innerHTML = `<tr><td colspan="3" class="text-center py-8 text-red-500">Failed to load EHB data.</td></tr>`;
                document.getElementById('teamKcTableBody').innerHTML = `<tr><td colspan="2" class="text-center py-8 text-red-500">Failed to load KC data.</td></tr>`;
            }
        }

        function renderEhbTable(playerData) {
            const tableBody = document.getElementById('ehbRankingsTableBody');
            tableBody.innerHTML = '';
            if (playerData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400">No player data found for this team.</td></tr>';
                return;
            }
            playerData.forEach((player, index) => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-800 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-bold">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#page=playerStats&player=${encodeURIComponent(player.displayName)}" class="text-custom-blue-300 hover:underline">${player.displayName}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${player.ehb.toFixed(2)}</td>
                `;
            });
        }

        function renderTeamKcTable(teamKcs) {
            const tableBody = document.getElementById('teamKcTableBody');
            tableBody.innerHTML = '';

            if (Object.keys(teamKcs).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center py-8 text-gray-400">No boss KC found for this team.</td></tr>';
                return;
            }

            const sortedBosses = Object.keys(teamKcs).sort();

            sortedBosses.forEach(bossName => {
                const prettyBossName = bossName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const kc = teamKcs[bossName];
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-800 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${prettyBossName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(kc)}</td>
                `;
            });
        }


        // --- Bingo Board Logic ---
        async function initializeBingoBoard(teamId) {
            try {
                const [boardData, raidValues, allTeamMembers, allKcData] = await Promise.all([
                    fetchWithLoader(BOARD_API_URL),
                    fetchWithLoader(RAID_ITEM_VALUES_API_URL),
                    fetchWithLoader(TEAMMEMBERS_API_URL),
                    fetchWithLoader(RSN_KC_API_URL)
                ]);

                const teamMembers = allTeamMembers.filter(m => m.team_id === teamId);
                const teamMemberNames = new Set(teamMembers.map(m => m.displayName));

                let teamDrops = appData.processedBingoDrops.filter(drop => teamMemberNames.has(drop.submitter));

                if (appData.activeEventStartDate && appData.activeEventEndDate) {
                    teamDrops = teamDrops.filter(drop => {
                        const dropDate = new Date(drop.reviewedDate);
                        return dropDate >= appData.activeEventStartDate && dropDate <= appData.activeEventEndDate;
                    });
                }

                const raidPointsMap = new Map(raidValues.map(item => [item.item.toLowerCase(), item.points]));
                const kcMap = new Map(allKcData.map(p => [p.RSN.toLowerCase(), p]));
                const tileCompletionStatus = new Map();

                boardData.forEach(tile => {
                    let completed = false, progress = 0, total = parseInt(tile.dropOrPointReq, 10) || 0;
                    const allowedItems = appData.tileItemsMap.get(tile.tile_id) || [];

                    if (tile.tileType === 'Unique') {
                        const matchingDrops = teamDrops.filter(drop => allowedItems.includes((drop.notes || '').toLowerCase()));
                        progress = matchingDrops.length;
                        if (total > 0) completed = progress >= total;
                    } else if (tile.tileType === 'Points') {
                        const matchingDrops = teamDrops.filter(drop => allowedItems.includes((drop.notes || '').toLowerCase()));
                        let currentPoints = 0;
                        matchingDrops.forEach(drop => {
                           const dropName = (drop.notes || '').toLowerCase();
                           if (raidPointsMap.has(dropName)) currentPoints += raidPointsMap.get(dropName);
                        });
                        progress = currentPoints;
                        if (total > 0) completed = progress >= total;
                    } else if (tile.tileType === 'KC') {
                        const bossNameForKc = (allowedItems[0] || '').replace(/ /g, '_').toLowerCase();
                        let totalKc = 0;
                        if (bossNameForKc) {
                            teamMembers.forEach(member => {
                                const rsns = [member.mainRSN, member.altRSN].filter(Boolean).map(rsn => rsn.toLowerCase());
                                rsns.forEach(rsn => {
                                    const playerData = kcMap.get(rsn);
                                    if (playerData) {
                                        const correctBossKey = Object.keys(playerData).find(key => key.toLowerCase() === bossNameForKc);
                                        if (correctBossKey && typeof playerData[correctBossKey] === 'number') {
                                            totalKc += playerData[correctBossKey];
                                        }
                                    }
                                });
                            });
                        }
                        progress = totalKc;
                        if (total > 0) completed = progress >= total;
                    }
                    tileCompletionStatus.set(tile.tile_id, { completed, progress, total });
                });

                renderBingoBoard(boardData, tileCompletionStatus, teamId);

            } catch (error) {
                console.error("Failed to initialize Bingo board:", error);
                document.getElementById('bingoBoardContainer').innerHTML = `<div class="text-center py-8 text-red-500 col-span-6">Failed to load bingo board.</div>`;
            }
        }

        function renderBingoBoard(boardData, completionStatus, teamId) {
            const container = document.getElementById('bingoBoardContainer');
            container.innerHTML = '';
            const tiles = Array(25).fill(null);

            boardData.forEach(tile => {
                const tileId = parseInt(tile.tile_id, 10);
                if (!isNaN(tileId) && tileId > 0 && tileId <= 25) {
                    tiles[tileId - 1] = tile;
                }
            });

            const rowComplete = Array(5).fill(true);
            const colComplete = Array(5).fill(true);
            let completedTilesCount = 0;
            let totalPoints = 0;
            let partialPoints = 0;

            for(let r = 0; r < 5; r++) {
                for(let c = 0; c < 5; c++) {
                    const tile = tiles[r * 5 + c];
                    const isComplete = tile && completionStatus.get(tile.tile_id)?.completed;

                    if (isComplete) {
                        completedTilesCount++;
                        totalPoints += tile.points || 0;
                    } else if (tile) {
                        const status = completionStatus.get(tile.tile_id) || { completed: false, progress: 0, total: 1 };
                        if (status.total > 0 && status.progress > 0) {
                            const progressRatio = status.progress / status.total;
                            partialPoints += progressRatio * (tile.points || 0);
                        }
                    }

                    if (!isComplete) {
                        rowComplete[r] = false;
                        colComplete[c] = false;
                    }
                }
            }

            rowComplete.forEach(isDone => { if (isDone) totalPoints += 5; });
            colComplete.forEach(isDone => { if (isDone) totalPoints += 5; });

            document.getElementById('teamTotalPoints').textContent = totalPoints;
            document.getElementById('teamPartialPoints').textContent = Math.floor(partialPoints);
            document.getElementById('teamTilesDone').textContent = `${completedTilesCount} / 25`;

            for (let i = 0; i < 36; i++) {
                const row = Math.floor(i / 6);
                const col = i % 6;
                const el = document.createElement('div');

                if (row < 5 && col < 5) {
                    const tileData = tiles[row * 5 + col];
                    if (tileData) {
                        const status = completionStatus.get(tileData.tile_id) || { completed: false, progress: 0, total: 1 };

                        el.className = `bingo-tile ${status.completed ? 'completed' : ''}`;
                        el.innerHTML = `
                            <a href="#page=dropLog&team=${teamId}&tile=${tileData.tile_id}" class="bingo-tile-link">
                                <div class="flex-grow flex flex-col justify-center items-center w-full overflow-hidden">
                                    <img src="${tileData.image_url || ''}" alt="${tileData.text || ''}" class="max-w-full h-auto" onerror="this.style.display='none'">
                                    <p class="font-semibold text-sm mt-2">${tileData.text || ''}</p>
                                </div>
                                <div class="w-full mt-auto flex-shrink-0">
                                    ${(tileData.tileType === 'Points' || tileData.tileType === 'KC') && status.total > 0 ? `
                                        <div class="progress-bar-container">
                                            <div class="progress-bar" style="width: ${Math.min(100, (status.progress / status.total) * 100)}%;"></div>
                                        </div>
                                        <p class="text-xs mt-1">${formatCurrency(status.progress)} / ${formatCurrency(status.total)} ${tileData.tileType === 'Points' ? 'pts' : ''}</p>
                                    ` : ''}
                                    ${tileData.tileType === 'Unique' && status.total > 0 ? `
                                        <p class="text-xs mt-1">${formatCurrency(status.progress)} / ${formatCurrency(status.total)} items</p>
                                    ` : ''}
                                </div>
                                <div class="tile-subtext">${tileData.sub_text || ''}</div>
                            </a>
                        `;
                    } else {
                         el.className = 'bingo-tile';
                    }
                } else if (row === 5 && col < 5) {
                     el.className = `bingo-tile bingo-bonus-tile ${colComplete[col] ? 'completed' : ''}`;
                     el.innerHTML = `+5`;
                } else if (col === 5 && row < 5) {
                     el.className = `bingo-tile bingo-bonus-tile ${rowComplete[row] ? 'completed' : ''}`;
                     el.innerHTML = `+5`;
                } else {
                    el.className = 'bingo-tile bg-transparent border-none';
                }
                 container.appendChild(el);
            }
        }

        // --- Player Stats Page Logic ---
        async function initializePlayerStats(playerName) {
            document.getElementById('playerStatsTitle').textContent = `${playerName}'s Stats`;

            let playerDrops = appData.processedBingoDrops.filter(drop => drop.submitter === playerName);
            if (appData.activeEventStartDate && appData.activeEventEndDate) {
                playerDrops = playerDrops.filter(drop => {
                    const dropDate = new Date(drop.reviewedDate);
                    return dropDate >= appData.activeEventStartDate && dropDate <= appData.activeEventEndDate;
                });
            }

            const playerDropsBody = document.getElementById('playerDropsTableBody');
            playerDropsBody.innerHTML = '';
            if (playerDrops.length > 0) {
                playerDrops.forEach(drop => {
                    const row = playerDropsBody.insertRow();
                    row.className = 'hover:bg-gray-800';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${formatToDDMMYYYY(drop.reviewedDate)}</td>
                        <td class="px-6 py-4">${drop.notes || 'N/A'}</td>
                        <td class="px-6 py-4 text-center">${generateImageUrlContent(drop.imageUrl)}</td>
                    `;
                });
            } else {
                playerDropsBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400">No drops submitted for this event.</td></tr>';
            }

            try {
                const [allTeamMembers, allKcData, bossEhbData] = await Promise.all([
                    fetchWithLoader(TEAMMEMBERS_API_URL),
                    fetchWithLoader(RSN_KC_API_URL),
                    fetchWithLoader(BOSS_EHB_API_URL)
                ]);

                const member = allTeamMembers.find(m => m.displayName === playerName);
                if (!member) return;

                const ehbMap = new Map(bossEhbData.map(b => [b.boss.toLowerCase().replace(/ /g, '_'), parseFloat(b.ehb)]));
                const kcMap = new Map(allKcData.map(p => [p.RSN.toLowerCase(), p]));
                const rsns = [member.mainRSN, member.altRSN].filter(Boolean).map(rsn => rsn.toLowerCase());
                const combinedKc = {};

                rsns.forEach(rsn => {
                    const playerData = kcMap.get(rsn);
                    if (playerData) {
                        for (const boss in playerData) {
                            if (boss !== 'RSN' && typeof playerData[boss] === 'number' && playerData[boss] > 0) {
                                if (!combinedKc[boss]) combinedKc[boss] = 0;
                                combinedKc[boss] += playerData[boss];
                            }
                        }
                    }
                });

                const bossStats = [];
                for (const boss in combinedKc) {
                    const ehbRate = ehbMap.get(boss.toLowerCase());
                    const ehb = (ehbRate && ehbRate > 0) ? (combinedKc[boss] / ehbRate) : 0;
                    bossStats.push({
                        name: boss.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        kc: combinedKc[boss],
                        ehb: ehb
                    });
                }

                bossStats.sort((a,b) => b.ehb - a.ehb);

                const playerBossKcBody = document.getElementById('playerBossKcTableBody');
                playerBossKcBody.innerHTML = '';
                if (bossStats.length > 0) {
                     bossStats.forEach(boss => {
                        const row = playerBossKcBody.insertRow();
                        row.className = 'hover:bg-gray-800';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">${boss.name}</td>
                            <td class="px-6 py-4">${formatCurrency(boss.kc)}</td>
                            <td class="px-6 py-4">${boss.ehb.toFixed(2)}</td>
                        `;
                    });
                } else {
                    playerBossKcBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400">No boss KC found.</td></tr>';
                }

                const totalEhb = bossStats.reduce((sum, boss) => sum + boss.ehb, 0);
                document.getElementById('playerTotalDrops').textContent = playerDrops.length;
                document.getElementById('playerTotalEhb').textContent = totalEhb.toFixed(2);

                renderEhbChart(bossStats);

            } catch (error) {
                 console.error("Failed to load player KC data:", error);
            }
        }

        function renderEhbChart(bossStats) {
            const container = document.getElementById('ehbChartContainer');
            container.innerHTML = '';
            const top10 = bossStats.slice(0, 10);
            const maxEhb = Math.max(...top10.map(b => b.ehb), 0);

            if (top10.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No EHB data to display.</p>';
                return;
            }

            top10.forEach(boss => {
                const barWidth = maxEhb > 0 ? (boss.ehb / maxEhb) * 100 : 0;
                const bar = document.createElement('div');
                bar.className = 'flex items-center mb-2';
                bar.innerHTML = `
                    <div class="w-1/3 text-right pr-4 text-sm">${boss.name}</div>
                    <div class="w-2/3">
                        <div class="bg-custom-blue-500 h-6 rounded-md" style="width: ${barWidth}%;">
                            <span class="text-xs font-bold pl-2">${boss.ehb.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                container.appendChild(bar);
            });
        }

        // --- App Initialization ---
        async function initializeAllData() {
            if (appData.isDataInitialized) return;
            try {
                const [drops, rValues, members, teams, tItems, events, boardData] = await Promise.all([
                    fetchWithLoader(DROPS_API_URL),
                    fetchWithLoader(RAID_ITEM_VALUES_API_URL),
                    fetchWithLoader(TEAMMEMBERS_API_URL),
                    fetchWithLoader(BINGO_TEAMS_API_URL),
                    fetchWithLoader(TILE_ITEMS_API_URL),
                    fetchWithLoader(EVENTS_API_URL),
                    fetchWithLoader(BOARD_API_URL)
                ]);

                appData.teams = teams;
                appData.boardData = boardData;
                appData.activeEvent = events.find(e => e.is_active == 1);
                if (appData.activeEvent) {
                    const originalStartDate = new Date(appData.activeEvent.start_date);
                    const originalEndDate = new Date(appData.activeEvent.end_date);
                    appData.activeEventStartDate = new Date(originalStartDate.getTime() - (24 * 60 * 60 * 1000));
                    appData.activeEventEndDate = new Date(originalEndDate.getTime() + (24 * 60 * 60 * 1000));
                    console.log('Active Event Found:', appData.activeEvent.name, 'Start (with buffer):', appData.activeEventStartDate, 'End (with buffer):', appData.activeEventEndDate);
                } else {
                    console.log('No active event found.');
                }

                tItems.forEach(item => {
                    if (!appData.tileItemsMap.has(item.tileId)) appData.tileItemsMap.set(item.tileId, []);
                    appData.tileItemsMap.get(item.tileId).push(item.dropName.toLowerCase());
                });

                const teamSelector = document.getElementById('teamSelector');
                teamSelector.innerHTML = '';
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelector.appendChild(option);
                });

                const pointsMap = new Map(rValues.map(item => [item.item.toLowerCase(), item.points]));
                const memberTeamMap = new Map(members.map(m => [m.displayName, m.team_id]));
                const teamIdToNameMap = new Map(teams.map(team => [team.id, team.name]));

                appData.processedBingoDrops = drops
                    .filter(drop => drop.bingo == 1)
                    .map(drop => {
                        const teamId = memberTeamMap.get(drop.submitter);
                        return { ...drop, points: pointsMap.get((drop.notes || '').toLowerCase()) || 0, teamId: teamId, teamName: teamIdToNameMap.get(teamId) || 'N/A' };
                    });
                appData.isDataInitialized = true;
            } catch (error) {
                console.error("Failed to initialize data:", error);
            }
        }

        function handleNavigation() {
            if (!appData.isDataInitialized) return;

            const hash = window.location.hash.slice(1);
            const params = new URLSearchParams(hash);
            const page = params.get('page') || 'teamProgress';
            const teamId = params.get('team');
            const tileId = params.get('tile');
            const playerName = params.get('player');

            showPage(page + 'Page');

            if (page === 'dropLog') {
                const filterParams = {};
                if (teamId) filterParams.teamId = parseInt(teamId, 10);
                if (tileId) filterParams.tileId = parseInt(tileId, 10);
                applySearchFilterAndRender(filterParams);
            } else if (page === 'teamProgress') {
                const teamSelector = document.getElementById('teamSelector');
                const currentTeamId = teamSelector.value;
                const teamIdToRender = teamId || currentTeamId || (teamSelector.options.length > 0 ? teamSelector.options[0].value : null);

                if (teamIdToRender) {
                    if (teamSelector.value !== teamIdToRender) {
                        teamSelector.value = teamIdToRender;
                    }
                    const numericTeamId = parseInt(teamIdToRender, 10);
                    const selectedTeamName = teamSelector.options[teamSelector.selectedIndex].text;
                    document.getElementById('teamStatsTitle').textContent = `${selectedTeamName} Stats`;
                    initializeEhbAndKcRankings(numericTeamId);
                    initializeBingoBoard(numericTeamId);
                }
            } else if (page === 'playerStats') {
                if (playerName) {
                     initializePlayerStats(decodeURIComponent(playerName));
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAllData();

            window.addEventListener('hashchange', handleNavigation);

            document.getElementById('teamSelector').addEventListener('change', (e) => {
                const newTeamId = e.target.value;
                const currentHash = new URLSearchParams(window.location.hash.slice(1));
                currentHash.set('page', 'teamProgress');
                currentHash.set('team', newTeamId);
                window.location.hash = currentHash.toString();
            });

            document.getElementById('searchInput').addEventListener('input', () => {
                const currentHash = new URLSearchParams(window.location.hash.slice(1));
                if (currentHash.get('page') === 'dropLog') {
                    applySearchFilterAndRender({
                        teamId: currentHash.get('team') ? parseInt(currentHash.get('team'), 10) : undefined,
                        tileId: currentHash.get('tile') ? parseInt(currentHash.get('tile'), 10) : undefined
                    });
                }
            });

            handleNavigation();
        });
    </script>
</body>
</html>
